<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <title>Kéo thả bình để rót vào cốc</title>
    <style>
        body {
            margin: 0;
            background: #ececec;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        canvas {
            width: 90vw;
            height: 90vh;
            border: 2px solid #2c3e50;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
            display: block;
            background: #fff;
        }

        #controls {
            margin: 10px;
        }

        button {
            margin-right: 10px;
            padding: 6px 12px;
            border: none;
            background: #3498db;
            color: #fff;
            border-radius: 6px;
            cursor: pointer;
        }

        button:hover {
            background: #2980b9;
        }

        #settingsPanel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #fff;
            padding: 12px;
            border: 1px solid #2c3e50;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            max-height: 80vh;
            overflow-y: auto;
        }

        #settingsPanel label {
            display: block;
            margin-top: 6px;
        }
    </style>
</head>

<body>

    <div id="controls">
        <button id="resetBtn">Reset</button>
        <button id="btnAddCup">Thêm cốc</button>
        <button id="settingsBtn">Cài đặt</button>
    </div>

    <div id="settingsPanel" style="display:none;">
        <h4>Cài đặt mức nước</h4>
        <label>Bình: <input type="number" id="bottleFillInput" /></label>
        <div id="cupsSettingsContainer"></div>
        <button id="applySettings" style="margin-top: 10px;">Áp dụng</button>
    </div>

    <canvas id="world"></canvas>

    <script>
        const canvas = document.getElementById("world");
        const ctx = canvas.getContext("2d");

        let bottle = {
            x: 550,
            y: 80,
            w: 120,
            h: 220,
            capacity: 1000,
            fill: 1000,
            pouring: false,
            angle: 0,
            dragging: false,
            offsetX: 0,
            offsetY: 0
        };

        let cups = [{
            x: 200,
            y: 150,
            w: 120,
            h: 180,
            capacity: 400,
            fill: 0,
            dragging: false,
            offsetX: 0,
            offsetY: 0
        }];

        // Lưu trạng thái ban đầu để reset
        function saveInitialState() {
            return {
                bottle: JSON.parse(JSON.stringify(bottle)),
                cups: JSON.parse(JSON.stringify(cups))
            };
        }
        let initialState = saveInitialState();

        function resizeCanvas() {
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;

            cups.forEach((cup, i) => {
                cup.x = canvas.width * 0.2 + i * 150;
                cup.y = canvas.height * 0.6;
            });

            bottle.x = canvas.width * 0.6;
            bottle.y = canvas.height * 0.2;
        }
        resizeCanvas();
        window.addEventListener("resize", resizeCanvas);

        const cupEmpty = new Image();
        const cupFull = new Image();
        const bottleEmpty = new Image();
        const bottleFull = new Image();

        let loaded = 0;

        function onLoad() {
            loaded++;
            if (loaded === 5) animate();
        }

        cupEmpty.onload = () => {
            setSizeKeepRatio(cups[0], cupEmpty, 130);
            onLoad();
        };

        cupFull.onload = onLoad;
        bottleEmpty.onload = () => {
            setSizeKeepRatio(bottle, bottleEmpty, 210);
            onLoad();
        };
        bottleFull.onload = onLoad;

        cupEmpty.src = "res/cup_empty.png";
        cupFull.src = "res/cup_full.png";
        bottleEmpty.src = "res/bottle_empty.png";
        bottleFull.src = "res/bottle_full.png";


        let t = 0;

        function setSizeKeepRatio(obj, img, targetHeight) {
            const ratio = img.naturalWidth / img.naturalHeight;
            obj.h = targetHeight;
            obj.w = obj.h * ratio;
        }

        function drawCup(cup, index, highlight = false) {
            if (highlight) {
                ctx.save();
                ctx.fillStyle = "rgba(0,200,255,0.15)";
                ctx.fillRect(cup.x - 10, cup.y - 10, cup.w + 20, cup.h + 20);
                ctx.restore();
            }

            if (typeof cupEmpty !== 'undefined' && cupEmpty.complete && cupEmpty.naturalWidth) {
                ctx.drawImage(cupEmpty, cup.x, cup.y, cup.w, cup.h);
            } else {
                ctx.strokeStyle = "#2c3e50";
                ctx.strokeRect(cup.x, cup.y, cup.w, cup.h);
            }

            if (cup.fill > 0) {
                const percent = cup.fill / cup.capacity;
                const waterHeight = cup.h * percent;
                ctx.save();
                ctx.beginPath();
                const waveHeight = 6;
                const waveLength = 50;
                ctx.moveTo(cup.x, cup.y + cup.h - waterHeight);
                for (let x = 0; x <= cup.w; x += 5) {
                    const y = Math.sin((x / waveLength) * Math.PI * 2 + t) * waveHeight;
                    ctx.lineTo(cup.x + x, cup.y + cup.h - waterHeight + y);
                }
                ctx.lineTo(cup.x + cup.w, cup.y + cup.h);
                ctx.lineTo(cup.x, cup.y + cup.h);
                ctx.closePath();
                ctx.clip();
                if (typeof cupFull !== 'undefined' && cupFull.complete && cupFull.naturalWidth) {
                    ctx.drawImage(cupFull, cup.x, cup.y, cup.w, cup.h);
                } else {
                    ctx.fillStyle = "rgba(0,150,255,0.6)";
                    ctx.fillRect(cup.x, cup.y + cup.h - waterHeight, cup.w, waterHeight);
                }
                ctx.restore();
            }

            ctx.fillStyle = "#2c3e50";
            ctx.font = "14px sans-serif";
            ctx.fillText(`Cốc ${index}: ${Math.round(cup.fill)} / ${cup.capacity} ml`, cup.x, cup.y + cup.h + 20);
        }

        function drawBottle() {
            ctx.save();
            ctx.translate(bottle.x + bottle.w / 2, bottle.y + bottle.h / 2);
            ctx.rotate(bottle.angle);
            ctx.drawImage(bottleEmpty, -bottle.w / 2, -bottle.h / 2, bottle.w, bottle.h);

            if (bottle.fill > 0) {
                const percent = bottle.fill / bottle.capacity;
                const waterHeight = bottle.h * percent;
                ctx.save();
                ctx.beginPath();
                const waveHeight = 5;
                const waveLength = 40;
                ctx.moveTo(-bottle.w / 2, -bottle.h / 2 + (bottle.h - waterHeight));
                for (let x = 0; x <= bottle.w; x += 5) {
                    const y = Math.sin((x / waveLength) * Math.PI * 2 + t) * waveHeight;
                    ctx.lineTo(-bottle.w / 2 + x, -bottle.h / 2 + (bottle.h - waterHeight) + y);
                }
                ctx.lineTo(bottle.w / 2, bottle.h / 2);
                ctx.lineTo(-bottle.w / 2, bottle.h / 2);
                ctx.closePath();
                ctx.clip();
                ctx.drawImage(bottleFull, -bottle.w / 2, -bottle.h / 2, bottle.w, bottle.h);
                ctx.restore();
            }
            ctx.restore();

            // Vẽ dòng nước cho TẤT CẢ các cốc đang được rót
            if (bottle.pouring && bottle.fill > 0) {
                const cx = bottle.x + bottle.w / 2;
                const cy = bottle.y + bottle.h / 2;
                const localX = -bottle.w / 2;
                const localY = -bottle.h / 2;

                const cos = Math.cos(bottle.angle);
                const sin = Math.sin(bottle.angle);

                const mouthX = cx + localX * cos - localY * sin;
                const mouthY = cy + localX * sin + localY * cos;

                // Vẽ dòng nước cho mỗi cốc gần bình
                cups.forEach(cup => {
                    if (isNearCup(bottle, cup) && cup.fill < cup.capacity) {
                        const targetX = cup.x + cup.w / 2;
                        const targetY = cup.y;

                        const length = targetY - mouthY;
                        const halfWidth = 10;

                        const gradient = ctx.createLinearGradient(mouthX, mouthY, targetX, targetY);
                        gradient.addColorStop(0, "rgba(0,150,255,0.8)");
                        gradient.addColorStop(0.5, "rgba(0,180,255,0.6)");
                        gradient.addColorStop(1, "rgba(0,200,255,0.2)");

                        ctx.beginPath();

                        for (let y = 0; y <= length; y += 5) {
                            const progress = y / length;
                            const xLerp = mouthX + (targetX - mouthX) * progress;
                            const yLerp = mouthY + (targetY - mouthY) * progress;

                            const offset = Math.sin((y / 25) * Math.PI * 2 + t) * 4;
                            const x = xLerp + offset - halfWidth;
                            const yPos = yLerp;

                            if (y === 0) ctx.moveTo(x, yPos);
                            else ctx.lineTo(x, yPos);
                        }

                        for (let y = length; y >= 0; y -= 5) {
                            const progress = y / length;
                            const xLerp = mouthX + (targetX - mouthX) * progress;
                            const yLerp = mouthY + (targetY - mouthY) * progress;

                            const offset = Math.sin((y / 25) * Math.PI * 2 + t) * 4;
                            const x = xLerp + offset + halfWidth;
                            const yPos = yLerp;

                            ctx.lineTo(x, yPos);
                        }

                        ctx.closePath();
                        ctx.fillStyle = gradient;
                        ctx.fill();
                    }
                });
            }

            ctx.fillStyle = "#2c3e50";
            ctx.font = "16px sans-serif";
            ctx.fillText(`Bình: ${Math.round(bottle.fill)} / ${bottle.capacity} ml`, bottle.x - 20, bottle.y + bottle.h + 50);
        }

        let highlightCupIndex = null;

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            let nearCups = []; // Danh sách các cốc gần bình

            // Kiểm tra các cốc gần và tự động bắt đầu rót
            cups.forEach((cup, i) => {
                const near = isNearCup(bottle, cup);
                if (near) nearCups.push(cup);

                // Auto bắt đầu rót khi thả và ở gần
                if (!bottle.dragging && near && bottle.fill > 0 && cup.fill < cup.capacity) {
                    bottle.pouring = true;
                }
            });

            // Nếu không còn cốc nào gần hoặc hết nước -> ngắt
            if (nearCups.length === 0 || bottle.fill <= 0 || bottle.dragging) {
                bottle.pouring = false;
            }

            // Rót nước vào TẤT CẢ các cốc gần
            if (bottle.pouring && nearCups.length > 0) {
                // Tính toán góc nghiêng trung bình hướng về các cốc
                let avgTargetX = 0, avgTargetY = 0;
                nearCups.forEach(cup => {
                    avgTargetX += cup.x + cup.w / 2;
                    avgTargetY += cup.y;
                });
                avgTargetX /= nearCups.length;
                avgTargetY /= nearCups.length;

                const cx = bottle.x + bottle.w / 2;
                const cy = bottle.y + bottle.h / 2;
                const localX = -bottle.w / 2, localY = -bottle.h / 2;
                const cos = Math.cos(bottle.angle), sin = Math.sin(bottle.angle);
                const mouthX = cx + localX * cos - localY * sin;
                const mouthY = cy + localX * sin + localY * cos;

                let targetAngle = Math.atan2(avgTargetY - mouthY, avgTargetX - mouthX);
                targetAngle = Math.max(targetAngle, -Math.PI / 2);
                targetAngle = Math.min(targetAngle, -0.2);
                bottle.angle += (targetAngle - bottle.angle) * 0.1;

                // Chia đều tốc độ rót cho các cốc
                const pourSpeed = 2;
                const pourPerCup = pourSpeed / nearCups.length;

                nearCups.forEach(cup => {
                    if (cup.fill < cup.capacity && bottle.fill > 0) {
                        const actualPour = Math.min(pourPerCup, bottle.fill, cup.capacity - cup.fill);
                        cup.fill += actualPour;
                        bottle.fill -= actualPour;

                        if (cup.fill >= cup.capacity) {
                            cup.fill = cup.capacity;
                        }
                    }
                });

                // Ngắt rót nếu hết nước hoặc tất cả cốc đã đầy
                if (bottle.fill <= 0 || nearCups.every(c => c.fill >= c.capacity)) {
                    bottle.pouring = false;
                }
            }

            // Bình về lại góc đứng khi không rót
            if (!bottle.pouring) {
                bottle.angle += (0 - bottle.angle) * 0.1;
            }

            // Vẽ
            t += 0.05;
            cups.forEach((c, i) => drawCup(c, i, nearCups.includes(c)));
            drawBottle();

            requestAnimationFrame(animate);
        }

        function isNearCup(bottle, cup) {
            const margin = 25;
            return (bottle.x < cup.x + cup.w + margin &&
                bottle.x + bottle.w > cup.x - margin &&
                bottle.y < cup.y + cup.h + margin &&
                bottle.y + bottle.h > cup.y - margin);
        }

        function addCup() {
            const baseCup = cups[0];

            const newCup = {
                x: 200 + cups.length * 150,
                y: baseCup.y,
                w: baseCup.w,
                h: baseCup.h,
                capacity: baseCup.capacity,
                fill: 0,
                dragging: false,
                offsetX: 0,
                offsetY: 0
            };

            cups.push(newCup);
            updateSettingsPanel();
        }

        function removeCup(index) {
            if (cups.length > 1) {
                cups.splice(index, 1);
                updateSettingsPanel();
            } else {
                alert("Phải có ít nhất 1 cốc!");
            }
        }

        function updateSettingsPanel() {
            const container = document.getElementById("cupsSettingsContainer");
            container.innerHTML = "";
            
            cups.forEach((cup, i) => {
                const div = document.createElement("div");
                div.style.marginTop = "8px";
                div.style.display = "flex";
                div.style.alignItems = "center";
                div.style.gap = "8px";
                
                const label = document.createElement("label");
                label.textContent = `Cốc ${i}: `;
                label.style.minWidth = "55px";
                
                const input = document.createElement("input");
                input.type = "number";
                input.id = `cup${i}FillInput`;
                input.value = cup.fill;
                input.style.width = "80px";
                
                const deleteBtn = document.createElement("button");
                deleteBtn.textContent = "Xóa";
                deleteBtn.style.padding = "4px 8px";
                deleteBtn.style.fontSize = "12px";
                deleteBtn.onclick = () => removeCup(i);
                
                div.appendChild(label);
                div.appendChild(input);
                if (cups.length > 1) {
                    div.appendChild(deleteBtn);
                }
                
                container.appendChild(div);
            });
        }

        document.getElementById("btnAddCup").addEventListener("click", addCup);

        canvas.addEventListener("mousedown", e => {
            const mx = e.offsetX,
                my = e.offsetY;
            if (mx > bottle.x && mx < bottle.x + bottle.w && my > bottle.y && my < bottle.y + bottle.h) {
                bottle.dragging = true;
                bottle.offsetX = mx - bottle.x;
                bottle.offsetY = my - bottle.y;
                return;
            }
            for (let i = cups.length - 1; i >= 0; i--) {
                const c = cups[i];
                if (mx > c.x && mx < c.x + c.w && my > c.y && my < c.y + c.h) {
                    c.dragging = true;
                    c.offsetX = mx - c.x;
                    c.offsetY = my - c.y;
                    break;
                }
            }
        });

        canvas.addEventListener("mousemove", e => {
            const mx = e.offsetX,
                my = e.offsetY;
            if (bottle.dragging) {
                bottle.x = mx - bottle.offsetX;
                bottle.y = my - bottle.offsetY;
            }
            cups.forEach(c => {
                if (c.dragging) {
                    c.x = mx - c.offsetX;
                    c.y = my - c.offsetY;
                }
            });
        });

        canvas.addEventListener("mouseup", () => {
            bottle.dragging = false;
            cups.forEach(c => c.dragging = false);
        });

        document.getElementById("resetBtn").addEventListener("click", () => {
            bottle = JSON.parse(JSON.stringify(initialState.bottle));
            cups = JSON.parse(JSON.stringify(initialState.cups));

            if (bottleEmpty.complete) setSizeKeepRatio(bottle, bottleEmpty, 210);
            if (cupEmpty.complete) {
                cups.forEach(c => setSizeKeepRatio(c, cupEmpty, 130));
            }
            
            updateSettingsPanel();
        });

        document.getElementById("settingsBtn").addEventListener("click", () => {
            const panel = document.getElementById("settingsPanel");
            const isOpen = panel.style.display !== "none";
            panel.style.display = isOpen ? "none" : "block";
            
            if (!isOpen) {
                document.getElementById("bottleFillInput").value = bottle.fill;
                updateSettingsPanel();
            }
        });

        document.getElementById("applySettings").addEventListener("click", () => {
            const v = parseInt(document.getElementById("bottleFillInput").value);
            if (!isNaN(v)) bottle.fill = Math.max(0, Math.min(bottle.capacity, v));
            
            cups.forEach((c, i) => {
                const inp = document.getElementById(`cup${i}FillInput`);
                if (inp) {
                    const val = parseInt(inp.value);
                    if (!isNaN(val)) c.fill = Math.max(0, Math.min(c.capacity, val));
                }
            });
            
            document.getElementById("settingsPanel").style.display = "none";
        });
    </script>
</body>

</html>