<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <title>Kéo thả bình để rót vào cốc</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 16px 24px;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #1a202c;
            margin: 0;
        }

        #controls {
            display: flex;
            gap: 12px;
        }

        button {
            padding: 10px 20px;
            border: none;
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
            color: #fff;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 2s ease;
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            cursor: not-allowed !important;
            opacity: 0.5 !important;
            transform: none !important;
        }

        #resetBtn {
            /* Đỏ nhẹ - reset */
            background: linear-gradient(135deg, #E85D75 0%, #D14D65 100%);
            box-shadow: 0 2px 8px rgba(232, 93, 117, 0.3);
        }

        #resetBtn:hover {
            box-shadow: 0 4px 12px rgba(232, 93, 117, 0.4);
        }

        #btnAddCup {
            /* Xanh lá nhẹ - thêm cốc */
            background: linear-gradient(135deg, #52C997 0%, #42B883 100%);
            box-shadow: 0 2px 8px rgba(82, 201, 151, 0.3);
        }

        #btnAddCup:hover {
            box-shadow: 0 4px 12px rgba(82, 201, 151, 0.4);
        }

        #btnAddMeasuringCup {
            /* Cam giáo dục - cốc đo */
            background: linear-gradient(135deg, #FF9A56 0%, #FF7E3D 100%);
            box-shadow: 0 2px 8px rgba(255, 154, 86, 0.3);
        }

        #btnAddMeasuringCup:hover {
            box-shadow: 0 4px 12px rgba(255, 154, 86, 0.4);
        }

        #settingsBtn {
            background: linear-gradient(135deg, #5B7C99 0%, #4A6B85 100%);
            box-shadow: 0 2px 8px rgba(91, 124, 153, 0.3);
        }

        #settingsBtn:hover {
            box-shadow: 0 4px 12px rgba(91, 124, 153, 0.4);
        }

        .canvas-wrapper {
            position: relative;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        canvas {
            width: 100%;
            height: 70vh;
            border-radius: 12px;
            display: block;
            /* Nền trắng sạch - dễ quan sát */
            background: #FFFFFF;
            cursor: grab;
        }

        canvas:active {
            cursor: grabbing;
        }

        #settingsPanel {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%) translateX(100%);
            /* ← Thêm translateX để ẩn bên phải */
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            height: 80vh;
            min-width: 320px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            opacity: 0;
            /* ← Bắt đầu trong suốt */
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            /* ← Animation mượt */
            pointer-events: none;
            /* ← Không tương tác khi ẩn */
        }

        #settingsPanel.active {
            transform: translateY(-50%) translateX(0);
            /* ← Trượt vào */
            opacity: 1;
            /* ← Hiện rõ */
            pointer-events: all;
            /* ← Cho phép tương tác */
        }

        #settingsOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            /* ← Đổi từ 0.3 thành 0.5 (đen hơn) */
            z-index: 999;
            backdrop-filter: blur(2px);
            opacity: 0;
            /* ← Bắt đầu trong suốt */
            transition: opacity 0.3s ease;
            /* ← Animation fade */
        }

        #settingsOverlay.active {
            display: block;
            opacity: 1;
            /* ← Fade in */
        }

        /* ← Thêm mới: Header cố định */
        #settingsHeader {
            padding: 24px 24px 16px 24px;
            background: rgba(255, 255, 255, 0.98);
            border-bottom: 1px solid #e2e8f0;
            flex-shrink: 0;
        }

        /* ← Thêm mới: Content cuộn được */
        #settingsContent {
            padding: 16px 24px 24px 24px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
            max-height: calc(80vh - 80px);
            /* ← Thêm dòng này, 80px là chiều cao header */
        }

        /* ← Thêm mới: Tùy chỉnh scrollbar */
        #settingsContent::-webkit-scrollbar {
            width: 8px;
        }

        #settingsContent::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        #settingsContent::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }

        #settingsContent::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        #settingsPanel h4 {
            margin: 0 0 16px 0;
            color: #1a202c;
            font-size: 18px;
            font-weight: 600;
        }

        #settingsPanel label {
            display: block;
            margin-top: 12px;
            color: #4a5568;
            font-size: 14px;
            font-weight: 500;
        }

        #settingsPanel input,
        #settingsPanel select {
            width: 100%;
            padding: 8px 12px;
            margin-top: 6px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        #settingsPanel input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        #settingsPanel input:focus,
        #settingsPanel select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        #settingsPanel select {
            cursor: pointer;
        }

        #settingsPanel hr {
            margin: 16px 0;
            border: none;
            border-top: 1px solid #e2e8f0;
        }

        #cupsSettingsContainer,
        #measuringCupsSettingsContainer {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .cup-item {
            padding: 12px;
            background: #f7fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cup-item:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .cup-item.expanded {
            background: #fff;
            border-color: #4A90E2;
            cursor: default;
        }

        .cup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            color: #1a202c;
            font-size: 14px;
            padding: 4px 0;
        }

        .cup-details {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
        }

        .cup-item.expanded .cup-details {
            display: block;
        }

        .cup-item.expanded .cup-header {
            font-weight: 600;
            color: #4A90E2;
        }

        #cupsSettingsContainer label,
        #measuringCupsSettingsContainer label {
            margin: 0 0 4px 0;
            font-size: 12px;
            color: #718096;
        }

        .delete-btn {
            margin-top: 8px;
            width: 100%;
            padding: 8px;
            font-size: 13px;
            background: linear-gradient(135deg, #E85D75 0%, #D14D65 100%);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            margin-top: 8px;
            cursor: pointer;
            font-size: 13px;
        }

        .settings-section {
            padding: 12px;
            background: #f7fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            margin-top: 8px;
        }

        .hide-all-btn {
            width: 100%;
            margin-top: 8px;
            background: linear-gradient(135deg, #5ED5A8 0%, #42B883 100%);
            color: white;
            box-shadow: 0 2px 6px rgba(66, 184, 131, 0.25);
            transition: all 0.3s ease;
        }

        .hide-all-btn.hidden-state {
            background: linear-gradient(135deg, #FF9A56 0%, #FF7E3D 100%);
            box-shadow: 0 2px 6px rgba(255, 154, 86, 0.25);
        }

        .hide-all-btn.hidden-state:hover {
            box-shadow: 0 4px 10px rgba(255, 154, 86, 0.35);
        }

        .hide-all-btn.ml-state {
            background: linear-gradient(135deg, #9F7AEA 0%, #805AD5 100%);
            box-shadow: 0 2px 6px rgba(159, 122, 234, 0.25);
        }

        .hide-all-btn.ml-state:hover {
            box-shadow: 0 4px 10px rgba(159, 122, 234, 0.35);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 16px;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .modal-content h3 {
            margin: 0 0 12px 0;
            color: #1a202c;
            font-size: 18px;
        }

        .modal-content p {
            margin: 0 0 20px 0;
            color: #4a5568;
            line-height: 1.5;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-buttons button {
            padding: 8px 16px;
            font-size: 14px;
        }

        #settingsOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 999;
            backdrop-filter: blur(2px);
        }

        #settingsOverlay.active {
            display: block;
        }

        /* ========== TOAST BANNER ========== */
        .toast-banner {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-120%);
            background: linear-gradient(135deg, #FFE89C 0%, #FFD966 100%);
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 16px 24px;
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3);
            z-index: 2000;
            max-width: 90%;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toast-banner.show {
            transform: translateX(-50%) translateY(0);
        }

        .toast-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-text {
            flex: 1;
            min-width: 250px;
            color: #6B4423;
            font-weight: 500;
            font-size: 15px;
        }

        .toast-btn-help {
            padding: 8px 16px;
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .toast-btn-help:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
        }

        .toast-btn-dismiss {
            padding: 8px 16px;
            background: linear-gradient(135deg, #52C997 0%, #42B883 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .toast-btn-dismiss:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(82, 201, 151, 0.4);
        }

        .toast-btn-close {
            width: 28px;
            height: 28px;
            padding: 0;
            background: rgba(107, 68, 35, 0.1);
            color: #6B4423;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .toast-btn-close:hover {
            background: rgba(107, 68, 35, 0.2);
        }

        /* ========== HELP PANEL MODAL ========== */
        .help-panel {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: helpSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes helpSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .help-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 28px;
            border-bottom: 2px solid #e2e8f0;
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);

            border-radius: 20px 20px 0 0;
        }

        .help-header h3 {
            margin: 0;
            color: white;
            font-size: 22px;
            font-weight: 600;
        }

        .close-help-btn {
            width: 36px;
            height: 36px;
            padding: 0;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 28px;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-help-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .help-content {
            padding: 24px 28px;
            overflow-y: auto;
            flex: 1;
        }

        .help-content::-webkit-scrollbar {
            width: 8px;
        }

        .help-content::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        .help-content::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }

        .help-content::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        .help-section {
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid #e2e8f0;
        }

        .help-section:last-of-type {
            border-bottom: none;
            margin-bottom: 16px;
        }

        .help-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .help-section h4 {
            margin: 0 0 16px 0;
            color: #1e293b;
            font-size: 18px;
            font-weight: 600;
        }

        .help-image-placeholder {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .help-section ul {
            margin: 12px 0 0 0;
            padding-left: 24px;
        }

        .help-section li {
            margin: 10px 0;
            color: #475569;
            line-height: 1.6;
            font-size: 15px;
        }

        .help-section li strong {
            color: #1e293b;
            font-weight: 600;
        }

        .help-footer {
            background: linear-gradient(135deg, #FFE89C 0%, #FFD966 100%);
            border: 2px solid #fbbf24;
            border-radius: 12px;
            padding: 16px;
            margin-top: 8px;
        }

        .help-footer p {
            margin: 0;
            color: #6B4423;
            font-size: 14px;
            line-height: 1.6;
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            .toast-content {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }

            .toast-text {
                min-width: 0;
            }

            .toast-btn-help,
            .toast-btn-dismiss {
                width: 100%;
            }

            .help-panel {
                width: 95%;
                max-height: 90vh;
            }

            .help-header {
                padding: 20px;
            }

            .help-content {
                padding: 20px;
            }

            .help-section li {
                font-size: 14px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>🌊 Mô phỏng rót nước</h1>
            <div id="controls">
                <button id="resetBtn">↺ Reset</button>
                <button id="btnAddCup">+ Cốc thường</button>
                <button id="btnAddMeasuringCup">📏 Cốc đo 1L</button>
                <button id="helpBtn">📖 Hướng dẫn</button>
                <button id="settingsBtn">⚙ Cài đặt</button>
            </div>
        </div>

        <div class="canvas-wrapper">
            <canvas id="world"></canvas>
        </div>
        <div id="settingsOverlay"></div>
    </div>

    <!-- Toast Banner -->
    <div id="toastBanner" class="toast-banner">
        <div class="toast-content">
            <span class="toast-icon">💡</span>
            <span class="toast-text">Mẹo: Kéo bình sang bên phải cốc và đặt cao hơn để rót nước!</span>
            <button id="toastHelpBtn" class="toast-btn-help">📖 Xem hướng dẫn</button>
            <button id="toastDismissBtn" class="toast-btn-dismiss">✓ Đã hiểu</button>
            <button id="toastCloseBtn" class="toast-btn-close">×</button>
        </div>
    </div>

    <!-- Settings Overlay -->
    <div id="settingsOverlay"></div>

    <!-- Settings Panel -->
    <div id="settingsPanel">
        <div id="settingsHeader">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h4 style="margin: 0;">⚙️ Cài đặt</h4>
                <button id="applySettings">✓ Áp dụng</button>
            </div>
        </div>

        <div id="settingsContent">
            <label>
                Đơn vị đo bình nước
                <select id="bottleUnitSelect">
                    <option value="ml">Mililit (ml)</option>
                    <option value="l">Lít (l)</option>
                </select>
            </label>

            <button class="hide-all-btn" id="toggleAllUnits">👁️ Ẩn tất cả đơn vị đo</button>

            <hr>

            <label style="font-size: 14px; font-weight: 600; color: #1a202c; margin-bottom: 8px;">
                🍶 Bình nước
            </label>
            <div class="settings-section">
                <label style="font-size: 12px; color: #718096;">
                    Mức nước hiện tại
                    <input type="number" id="bottleFillInput" />
                </label>
                <label style="font-size: 12px; color: #718096;">
                    Dung tích tối đa
                    <input type="number" id="bottleCapacityInput" />
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="bottleShowUnit" checked />
                    <span>Hiển thị đơn vị đo</span>
                </label>
            </div>

            <hr>

            <label style="font-size: 14px; font-weight: 600; color: #1a202c; margin-bottom: 8px;">
                🥤 Cốc thường
            </label>
            <div id="cupsSettingsContainer" style="margin-top: 8px;"></div>

            <hr>

            <label style="font-size: 14px; font-weight: 600; color: #1a202c; margin-bottom: 8px;">
                📏 Cốc đo 1 lít
            </label>
            <div id="measuringCupsSettingsContainer" style="margin-top: 8px;"></div>

            <hr>
        </div>
    </div>

    <!-- Help Panel Modal -->
    <div id="helpModal" class="modal-overlay">
        <div class="help-panel">
            <div class="help-header">
                <h3>📖 Hướng dẫn sử dụng</h3>
                <button id="closeHelpBtn" class="close-help-btn">×</button>
            </div>
            <div class="help-content">
                <section class="help-section">
                    <div class="help-icon">🌊</div>
                    <h4>1. Cách rót nước</h4>
                    <div class="help-image-placeholder">
                        <svg width="100%" height="120" viewBox="0 0 200 120">
                            <rect x="140" y="20" width="40" height="60" fill="#e0f2fe" stroke="#0284c7" stroke-width="2"
                                rx="5" />
                            <text x="160" y="95" text-anchor="middle" font-size="10" fill="#64748b">Cốc</text>
                            <rect x="110" y="10" width="25" height="50" fill="#bae6fd" stroke="#0284c7" stroke-width="2"
                                rx="3" />
                            <text x="122" y="70" text-anchor="middle" font-size="10" fill="#64748b">Bình</text>
                            <path d="M 135 35 L 145 35" stroke="#ef4444" stroke-width="2" marker-end="url(#arrowred)" />
                            <defs>
                                <marker id="arrowred" markerWidth="10" markerHeight="10" refX="5" refY="3"
                                    orient="auto">
                                    <polygon points="0 0, 6 3, 0 6" fill="#ef4444" />
                                </marker>
                            </defs>
                        </svg>
                    </div>
                    <ul>
                        <li>Kéo bình nước sang <strong>bên phải</strong> cốc</li>
                        <li>Đặt bình <strong>cao hơn</strong> cốc (góc trái trên bình phải cao hơn cạnh trên cốc một
                            khoảng)</li>
                        <li>Bình sẽ tự động <strong>nghiêng</strong> và rót nước</li>
                        <li><strong>Click vào bình</strong> để kích hoạt chế độ rót (với cốc mới tạo)</li>
                    </ul>
                </section>

                <section class="help-section">
                    <div class="help-icon">🥤</div>
                    <h4>2. Thêm/Xóa cốc</h4>
                    <div class="help-image-placeholder">
                        <svg width="100%" height="80" viewBox="0 0 200 80">
                            <rect x="30" y="20" width="35" height="50" fill="#e0f2fe" stroke="#0284c7" stroke-width="2"
                                rx="5" />
                            <rect x="80" y="20" width="35" height="50" fill="#e0f2fe" stroke="#0284c7" stroke-width="2"
                                rx="5" />
                            <rect x="130" y="20" width="35" height="50" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"
                                rx="5" />
                            <line x1="135" y1="30" x2="160" y2="30" stroke="#78716c" stroke-width="1" />
                            <line x1="135" y1="45" x2="160" y2="45" stroke="#78716c" stroke-width="1" />
                            <line x1="135" y1="60" x2="160" y2="60" stroke="#78716c" stroke-width="1" />
                            <text x="47.5" y="78" text-anchor="middle" font-size="9" fill="#64748b">Cốc thường</text>
                            <text x="147.5" y="78" text-anchor="middle" font-size="9" fill="#64748b">Cốc đo</text>
                        </svg>
                    </div>
                    <ul>
                        <li>Nhấn <strong>"+ Cốc thường"</strong> để thêm cốc bình thường</li>
                        <li>Nhấn <strong>"📏 Cốc đo 1L"</strong> để thêm cốc có vạch chia</li>
                        <li>Tối đa <strong>5 cốc</strong> cùng lúc</li>
                        <li>Xóa cốc trong <strong>⚙ Cài đặt → chọn cốc → 🗑 Xóa</strong></li>
                    </ul>
                </section>

                <section class="help-section">
                    <div class="help-icon">⚙️</div>
                    <h4>3. Cài đặt</h4>
                    <ul>
                        <li>Điều chỉnh <strong>dung tích</strong> và <strong>mức nước</strong> của bình/cốc</li>
                        <li>Chuyển đổi <strong>đơn vị</strong> giữa ml và lít</li>
                        <li>Ẩn/hiện <strong>thông tin đơn vị đo</strong> trên màn hình</li>
                        <li>Bật/tắt <strong>vạch chia</strong> trên cốc đo 1L</li>
                    </ul>
                </section>

                <section class="help-section">
                    <div class="help-icon">🎮</div>
                    <h4>4. Thao tác khác</h4>
                    <ul>
                        <li><strong>Kéo thả</strong> bình và cốc để di chuyển vị trí</li>
                        <li>Nhấn <strong>"↺ Reset"</strong> để khởi động lại trò chơi</li>
                        <li>Nhấn <strong>"✓ Áp dụng"</strong> trong Cài đặt để lưu thay đổi</li>
                        <li>Cốc mới tạo cần <strong>click vào bình</strong> trước khi rót</li>
                    </ul>
                </section>

                <div class="help-footer">
                    <p>💡 <strong>Mẹo:</strong> Thử nghiệm với các vị trí khác nhau để hiểu rõ cách rót nước!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <h3>💾 Lưu thay đổi?</h3>
            <p>Bạn có thay đổi chưa được lưu. Bạn muốn lưu các thay đổi này không?</p>
            <div class="modal-buttons">
                <button id="modalCancel" style="background: linear-gradient(135deg, #5B7C99 0%, #4A6B85 100%);">← Quay
                    lại</button>
                <button id="modalConfirm" style="background: linear-gradient(135deg, #52C997 0%, #42B883 100%);">✓ Lưu
                    và đóng</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById("world");
        const ctx = canvas.getContext("2d");

        // Biến toàn cục
        let settingsChanged = false;
        let bottle = {
            x: 550,
            y: 80,
            w: 120,
            h: 220,
            capacity: 2000,
            fill: 2000,
            pouring: false,
            angle: 0,
            dragging: false,
            offsetX: 0,
            offsetY: 0,
            showUnit: true,
            unit: 'l'
        };

        let cups = [{
            x: 200,
            y: 150,
            w: 120,
            h: 180,
            capacity: 1000,
            fill: 0,
            dragging: false,
            offsetX: 0,
            offsetY: 0,
            showUnit: true,
            showScale: false,
            type: 'normal',
            unit: 'l',
            justCreated: true
        }];
        // Lưu state ban đầu và state tạm thời
        let savedState = null;
        let tempState = null;

        function saveInitialState() {
            return {
                bottle: JSON.parse(JSON.stringify(bottle)),
                cups: JSON.parse(JSON.stringify(cups))
            };
        }
        let initialState = saveInitialState();

        // Images
        const cupEmpty = new Image();
        const cupFull = new Image();
        const bottleEmpty = new Image();
        const bottleFull = new Image();
        const measuredCupEmpty = new Image();
        const measuredCupFull = new Image();
        let loaded = 0;
        let t = 0;

        function onLoad() {
            loaded++;
            if (loaded === 6) {
                animate();
                updateAddCupButton();
            }
        }

        cupEmpty.onload = () => {
            cups.forEach(cup => {
                if (cup.type === 'normal') {
                    setSizeKeepRatio(cup, cupEmpty, 130);
                }
            });
            onLoad();
        };
        cupFull.onload = onLoad;
        bottleEmpty.onload = () => {
            setSizeKeepRatio(bottle, bottleEmpty, 210);
            onLoad();
        };
        bottleFull.onload = onLoad;
        measuredCupEmpty.onload = () => {
            cups.forEach(cup => {
                if (cup.type === 'measuring') {
                    setSizeKeepRatio(cup, measuredCupEmpty, 160);
                }
            });
            onLoad();
        };
        measuredCupFull.onload = onLoad;

        cupEmpty.src = "res/cup_empty.png?v=20251014234757";
        cupFull.src = "res/cup_full.png?v=20251014234757";
        bottleEmpty.src = "res/bottle_empty.png?v=20251014234757";
        bottleFull.src = "res/bottle_full.png?v=20251014234757";
        measuredCupEmpty.src = "res/measured_cup_empty.png?v=20251014234757";
        measuredCupFull.src = "res/measured_cup_full.png?v=20251014234757";

        function resizeCanvas() {
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
            cups.forEach((cup, i) => {
                if (cup.type === 'measuring' && cup.showScale) {
                    cup.x = canvas.width * 0.9 + i * 100;
                    cup.y = canvas.height * 0.4;
                } else {
                    cup.x = canvas.width * 0.2 + i * 150;
                    cup.y = canvas.height * 0.6;
                }
            });
            bottle.x = canvas.width * 0.6;
            bottle.y = canvas.height * 0.2;
        }
        resizeCanvas();
        window.addEventListener("resize", resizeCanvas);

        function setSizeKeepRatio(obj, img, targetHeight) {
            const ratio = img.naturalWidth / img.naturalHeight;
            obj.h = targetHeight;
            obj.w = obj.h * ratio;
        }

        function drawCup(cup, index, highlight = false) {
            if (highlight) {
                ctx.save();
                ctx.fillStyle = "rgba(0,200,255,0.15)";
                ctx.fillRect(cup.x - 10, cup.y - 10, cup.w + 20, cup.h + 20);
                ctx.restore();
            }

            // Vẽ cốc rỗng (nền)
            if (cupEmpty.complete) {
                if (cup.type === 'measuring' && cup.showScale) {
                    // Vẽ cốc đo với tỉ lệ gốc (không kéo dãn)
                    ctx.drawImage(measuredCupEmpty, cup.x, cup.y, cup.w, cup.h);
                } else {
                    ctx.drawImage(cupEmpty, cup.x, cup.y, cup.w, cup.h);
                }
            } else {
                ctx.strokeStyle = "#2c3e50";
                ctx.strokeRect(cup.x, cup.y, cup.w, cup.h);
            }

            // Vẽ nước
            if (cup.fill > 0) {
                const percent = cup.fill / cup.capacity;
                const waterHeight = cup.h * percent;

                // Xử lý riêng cho cốc đo (cắt ảnh với tỉ lệ chính xác)
                if (cup.type === 'measuring' && cup.showScale && measuredCupFull.complete) {
                    // Thông số ảnh gốc (measured_cup_full.png: 370×392px)
                    const imgWidth = measuredCupFull.naturalWidth; // 370px
                    const imgHeight = measuredCupFull.naturalHeight; // 392px

                    // Sử dụng số liệu đo thực tế (đo từ đáy ảnh lên):
                    // Vạch: 0ml=13px, 100ml=33px, 200ml=64px, 300ml=95px, 400ml=126px, 
                    //       500ml=157px, 900ml=281px, 1000ml=313px
                    // 
                    // Phân tích: 
                    // - 0→100ml: 20px (đáy cốc rộng)
                    // - 100→900ml: ~31px/100ml (đều đặn)
                    // - Vùng ổn định: 100-900ml có tỷ lệ tuyến tính

                    const waterBottomY = 392 - 13; // Đáy nước = 379px (0ml)
                    const waterTopY = 392 - 313; // Đỉnh nước = 79px (1000ml)

                    // Tính vị trí Y dựa trên ml hiện tại
                    const currentMl = cup.fill;
                    let sourceY;

                    if (currentMl <= 100) {
                        // Vùng 0-100ml: nội suy tuyến tính
                        const ratio = currentMl / 100;
                        const heightInImage = 20 * ratio; // 0→100ml = 20px
                        sourceY = waterBottomY - heightInImage;
                    } else {
                        // Vùng 100-1000ml: tỷ lệ đều 31px/100ml
                        const mlAbove100 = currentMl - 100;
                        const heightAbove100 = (mlAbove100 / 100) * 31; // 31px mỗi 100ml
                        sourceY = (392 - 33) - heightAbove100; // Bắt đầu từ vạch 100ml (y=359)
                    }

                    // Giới hạn vùng cắt trong phạm vi nước (không vượt quá đỉnh nước)
                    const clampedSourceY = Math.max(waterTopY, sourceY);
                    const clampedSourceHeight = waterBottomY - clampedSourceY;

                    // Tính scale dựa trên tỷ lệ ảnh gốc để đảm bảo chính xác
                    // Tính scale từ cả width và height, lấy giá trị nhỏ hơn để giữ nguyên tỷ lệ
                    const scaleW = cup.w / imgWidth;
                    const scaleH = cup.h / imgHeight;
                    const scale = Math.min(scaleW, scaleH); // Dùng scale nhỏ hơn để không bị méo

                    // Tính lại kích thước thực tế hiển thị (giữ nguyên tỷ lệ ảnh gốc)
                    const actualWidth = imgWidth * scale;
                    const actualHeight = imgHeight * scale;

                    // Căn giữa nếu cốc rộng hơn ảnh sau khi scale
                    const offsetX = (cup.w - actualWidth) / 2;
                    const offsetY = (cup.h - actualHeight) / 2;

                    // Tính vị trí trên canvas: 
                    const destY = cup.y + offsetY + (clampedSourceY * scale);
                    const destHeight = clampedSourceHeight * scale;
                    const destX = cup.x + offsetX;
                    const destWidth = actualWidth;

                    // Vẽ phần nước đã cắt
                    ctx.drawImage(
                        measuredCupFull,
                        0, // sourceX: từ trái ảnh gốc
                        clampedSourceY, // sourceY: vị trí bắt đầu cắt
                        imgWidth, // sourceWidth: toàn bộ chiều rộng gốc
                        clampedSourceHeight, // sourceHeight: chiều cao cắt
                        destX, // destX: vị trí x trên canvas (có căn giữa)
                        destY, // destY: vị trí y trên canvas
                        destWidth, // destWidth: chiều rộng thực tế (giữ tỷ lệ)
                        destHeight // destHeight: chiều cao canvas
                    );
                } else {
                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(cup.x, cup.y + cup.h - waterHeight);

                    // Tạo sóng nước
                    for (let x = 0; x <= cup.w; x += 5) {
                        const y = Math.sin((x / 50) * Math.PI * 2 + t) * 6;
                        ctx.lineTo(cup.x + x, cup.y + cup.h - waterHeight + y);
                    }

                    ctx.lineTo(cup.x + cup.w, cup.y + cup.h);
                    ctx.lineTo(cup.x, cup.y + cup.h);
                    ctx.closePath();
                    ctx.clip();

                    if (cupFull.complete) {
                        ctx.drawImage(cupFull, cup.x, cup.y, cup.w, cup.h);
                    } else {
                        ctx.fillStyle = "rgba(0,150,255,0.6)";
                        ctx.fillRect(cup.x, cup.y + cup.h - waterHeight, cup.w, waterHeight);
                    }
                    ctx.restore();
                }
            }
            // Hiển thị thông tin
            if (cup.showUnit) {
                ctx.fillStyle = "#1a202c";
                ctx.font = "bold 14px sans-serif";
                const cupUnit = cup.unit || 'l';
                const displayFill = cupUnit === "l" ? (cup.fill / 1000).toFixed(2) : Math.round(cup.fill);
                const displayCapacity = cupUnit === "l" ? (cup.capacity / 1000).toFixed(2) : cup.capacity;
                const cupType = cup.type === 'measuring' ? 'Cốc đo' : 'Cốc';
                const normalCupIndex = cups.filter((c, i) => c.type === cup.type && cups.indexOf(c) <= cups.indexOf(
                    cup)).length;
                ctx.fillText(`${cupType} ${normalCupIndex}: ${displayFill} / ${displayCapacity} ${cupUnit}`, cup.x, cup
                    .y + cup.h + 20);
            }
        }

        function drawBottle() {
            ctx.save();
            ctx.translate(bottle.x + bottle.w / 2, bottle.y + bottle.h / 2);
            ctx.rotate(bottle.angle);
            ctx.drawImage(bottleEmpty, -bottle.w / 2, -bottle.h / 2, bottle.w, bottle.h);

            if (bottle.fill > 0) {
                const percent = bottle.fill / bottle.capacity;
                const waterHeight = bottle.h * percent;
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(-bottle.w / 2, -bottle.h / 2 + (bottle.h - waterHeight));
                for (let x = 0; x <= bottle.w; x += 5) {
                    const y = Math.sin((x / 40) * Math.PI * 2 + t) * 5;
                    ctx.lineTo(-bottle.w / 2 + x, -bottle.h / 2 + (bottle.h - waterHeight) + y);
                }
                ctx.lineTo(bottle.w / 2, bottle.h / 2);
                ctx.lineTo(-bottle.w / 2, bottle.h / 2);
                ctx.closePath();
                ctx.clip();
                ctx.drawImage(bottleFull, -bottle.w / 2, -bottle.h / 2, bottle.w, bottle.h);
                ctx.restore();
            }
            ctx.restore();

            // Vẽ dòng nước
            if (bottle.pouring && bottle.fill > 0) {
                const cx = bottle.x + bottle.w / 2;
                const cy = bottle.y + bottle.h / 2;
                const cos = Math.cos(bottle.angle);
                const sin = Math.sin(bottle.angle);
                const mouthX = cx - bottle.w / 2 * cos + bottle.h / 2 * sin;
                const mouthY = cy - bottle.w / 2 * sin - bottle.h / 2 * cos;

                let targetCup = null;
                let minDist = Infinity;
                cups.forEach(cup => {
                    const bottleCenterX = bottle.x + bottle.w / 2;
                    const cupCenterX = cup.x + cup.w / 2;
                    const isBottleOnRight = bottleCenterX > cupCenterX;

                    if (isNearCup(bottle, cup) && cup.fill < cup.capacity && isBottleOnRight) {
                        const dist = Math.hypot((bottle.x + bottle.w / 2) - (cup.x + cup.w / 2), (bottle.y +
                            bottle.h / 2) - (cup.y + cup.h / 2));
                        if (dist < minDist) {
                            minDist = dist;
                            targetCup = cup;
                        }
                    }
                });

                if (targetCup) {
                    const targetX = targetCup.x + targetCup.w / 2;
                    const targetY = targetCup.y;

                    const bottleCenterX = bottle.x + bottle.w / 2;
                    const bottleCenterY = bottle.y + bottle.h / 2;

                    // Tính vị trí miệng bình dựa trên góc quay
                    const cos = Math.cos(bottle.angle);
                    const sin = Math.sin(bottle.angle);
                    // Miệng bình ở đầu trên (đỉnh bình)
                    const mouthRelativeX = sin * bottle.h / 2;
                    const mouthRelativeY = -cos * bottle.h / 2;

                    const actualMouthX = bottleCenterX + mouthRelativeX;

                    // Kiểm tra: cốc phải nằm về phía bình đang nghiêng
                    const cupDirection = targetX - bottleCenterX; // Dương = cốc ở bên phải, Âm = cốc ở bên trái
                    const tiltDirection = mouthRelativeX; // Dương = nghiêng phải, Âm = nghiêng trái
                    const isSameDirection = (cupDirection * tiltDirection) > 0; // Cùng dấu = cùng hướng

                    // Kiểm tra các điều kiện
                    const angleInDegrees = bottle.angle * 180 / Math.PI;
                    const isBottleTilted = Math.abs(bottle.angle) > 0.17;
                    const isMouthAboveCup = mouthY < targetY + 50;

                    if (isBottleTilted && isMouthAboveCup && isSameDirection) {
                        const length = targetY - mouthY;

                        const gradient = ctx.createLinearGradient(mouthX, mouthY, targetX, targetY);
                        gradient.addColorStop(0, "rgba(0,150,255,0.8)");
                        gradient.addColorStop(0.5, "rgba(0,180,255,0.6)");
                        gradient.addColorStop(1, "rgba(0,200,255,0.2)");

                        ctx.beginPath();
                        for (let y = 0; y <= length; y += 5) {
                            const progress = y / length;
                            const xLerp = mouthX + (targetX - mouthX) * progress;
                            const yLerp = mouthY + (targetY - mouthY) * progress;
                            const offset = Math.sin((y / 25) * Math.PI * 2 + t) * 4;
                            const x = xLerp + offset - 10;
                            if (y === 0) ctx.moveTo(x, yLerp);
                            else ctx.lineTo(x, yLerp);
                        }
                        for (let y = length; y >= 0; y -= 5) {
                            const progress = y / length;
                            const xLerp = mouthX + (targetX - mouthX) * progress;
                            const yLerp = mouthY + (targetY - mouthY) * progress;
                            const offset = Math.sin((y / 25) * Math.PI * 2 + t) * 4;
                            ctx.lineTo(xLerp + offset + 10, yLerp);
                        }
                        ctx.closePath();
                        ctx.fillStyle = gradient;
                        ctx.fill();
                    }
                }
            }

            // Hiển thị thông tin bình
            if (bottle.showUnit) {
                ctx.fillStyle = "#1a202c";
                ctx.font = "bold 16px sans-serif";
                const bottleUnit = bottle.unit || 'l';
                const displayFill = bottleUnit === "l" ? (bottle.fill / 1000).toFixed(2) : Math.round(bottle
                    .fill);
                const displayCapacity = bottleUnit === "l" ? (bottle.capacity / 1000).toFixed(2) : bottle
                    .capacity;
                ctx.fillText(`Bình: ${displayFill} / ${displayCapacity} ${bottleUnit}`, bottle.x - 20, bottle.y + bottle
                    .h + 50);
            }
        }

        function isNearCup(bottle, cup) {
            const margin = 50;

            // Kiểm tra khoảng cách gần
            const isInRange = (bottle.x < cup.x + cup.w + margin &&
                bottle.x + bottle.w > cup.x - margin &&
                bottle.y < cup.y + cup.h + margin &&
                bottle.y + bottle.h > cup.y - margin);

            if (!isInRange) return false;

            // Không chọn cốc vừa mới tạo
            if (cup.justCreated) return false;

            // Kiểm tra bình phải ở bên phải cốc
            const bottleCenterX = bottle.x + bottle.w / 2;
            const cupCenterX = cup.x + cup.w / 2;
            const isBottleOnRight = bottleCenterX > cupCenterX;

            // Kiểm tra góc trái trên bình phải cao hơn cạnh trên cùng của cốc một khoảng theo tỉ lệ màn hình
            const bottleTopLeftY = bottle.y; // Góc trái trên của bình
            const cupTopY = cup.y; // Cạnh trên cùng của cốc
            const minGap = canvas.height * 0.05; // Khoảng cách tối thiểu = 5% chiều cao canvas
            const isBottleHighEnough = bottleTopLeftY < (cupTopY - minGap); // Bình phải cao hơn cốc ít nhất minGap

            // Chỉ chọn cốc khi đủ cả 3 điều kiện
            return isBottleOnRight && isBottleHighEnough;
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            let nearestCup = null;
            let minDistance = Infinity;
            cups.forEach(cup => {
                const bottleCenterX = bottle.x + bottle.w / 2;
                const cupCenterX = cup.x + cup.w / 2;
                const isBottleOnRight = bottleCenterX > cupCenterX;

                if (isNearCup(bottle, cup) && cup.fill < cup.capacity && isBottleOnRight) {
                    const distance = Math.hypot((bottle.x + bottle.w / 2) - (cup.x + cup.w / 2), (bottle.y +
                        bottle.h / 2) - (cup.y + cup.h / 2));
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestCup = cup;
                    }
                }
            });

            if (!bottle.dragging && nearestCup && bottle.fill > 0) {
                bottle.pouring = true;
            } else if (bottle.dragging || !nearestCup || bottle.fill <= 0) {
                bottle.pouring = false;
            }

            if (bottle.pouring && nearestCup) {
                // Tính tọa độ tâm bình và tâm cốc
                const cx = bottle.x + bottle.w / 2;
                const cy = bottle.y + bottle.h / 2;
                const cupTargetX = nearestCup.x + nearestCup.w / 2;
                const cupTargetY = nearestCup.y;

                // Tính góc nghiêng tối ưu từ tâm bình đến đỉnh cốc
                const dx = cupTargetX - cx;
                const dy = cupTargetY - cy;
                let targetAngle = Math.atan2(dy, dx) - Math.PI / 2;

                // Giới hạn góc nghiêng từ ~-29° đến ~-14°
                const minAngle = -Math.PI * 0.16;
                const maxAngle = -Math.PI * 0.08;
                targetAngle = Math.max(minAngle, Math.min(maxAngle, targetAngle));

                // Xoay bình mượt mà về góc mục tiêu (smooth transition)
                bottle.angle += (targetAngle - bottle.angle) * 0.1;

                //  Kiểm tra bình đã nghiêng đủ góc chưa (để rót nước)
                const isBottleTilted = Math.abs(bottle.angle) > 0.17; // Phải nghiêng > ~10°

                // Chỉ rót nước khi bình đã nghiêng đủ góc
                if (isBottleTilted) {
                    // Tính tốc độ rót dựa trên đơn vị đo
                    const bottleUnit = bottle.unit || 'l';
                    const cupUnit = nearestCup.unit || 'l';

                    // Tốc độ cơ bản: 2 đơn vị/frame
                    const basePourSpeed = 2;

                    // Hệ số nhân tốc độ (ml rót nhanh hơn lít)
                    const bottleSpeedMultiplier = bottleUnit === 'ml' ? 1000 : 1;
                    const cupSpeedMultiplier = cupUnit === 'ml' ? 1000 : 1;

                    // Lấy tốc độ trung bình giữa bình và cốc
                    const speedMultiplier = (bottleSpeedMultiplier + cupSpeedMultiplier) / 2;
                    const calculatedSpeed = basePourSpeed * speedMultiplier;

                    // Giới hạn tốc độ tối đa: 15 đơn vị/frame
                    const maxSpeed = 15;
                    const pourSpeed = Math.min(calculatedSpeed, maxSpeed);

                    // Tính lượng nước thực tế được rót (không vượt quá lượng còn lại hoặc dung tích cốc)
                    const actualPour = Math.min(pourSpeed, bottle.fill, nearestCup.capacity - nearestCup.fill);

                    // Chuyển nước từ bình sang cốc
                    nearestCup.fill += actualPour;
                    bottle.fill -= actualPour;

                    // Dừng rót khi cốc đầy
                    if (nearestCup.fill >= nearestCup.capacity) {
                        nearestCup.fill = nearestCup.capacity;
                        bottle.pouring = false;
                    }
                }
            }
            if (!bottle.pouring) {
                bottle.angle += (0 - bottle.angle) * 0.1;
            }

            t += 0.05;
            cups.forEach((c, i) => drawCup(c, i, c === nearestCup));
            drawBottle();
            requestAnimationFrame(animate);
        }

        function addCup(type = 'normal') {
            if (cups.length >= 5) {
                alert("⚠️ Chỉ có thể tạo tối đa 5 cốc!");
                return;
            }

            const baseCup = cups[0];
            const lastCup = cups[cups.length - 1];
            let newX = lastCup.x + lastCup.w + 35;
            let newY = lastCup.y;

            let newW, newH, newCapacity;

            if (type === 'measuring') {
                if (measuredCupEmpty.complete) {
                    const ratio = measuredCupEmpty.naturalWidth / measuredCupEmpty.naturalHeight;
                    newH = 160;
                    newW = newH * ratio;
                } else {
                    newW = 100;
                    newH = 160;
                }
                newCapacity = 1000;
            } else {
                if (cupEmpty.complete) {
                    const ratio = cupEmpty.naturalWidth / cupEmpty.naturalHeight;
                    newH = 130;
                    newW = newH * ratio;
                } else {
                    newW = 120;
                    newH = 130;
                }
                newCapacity = 1000;
            }

            if (newX + newW > canvas.width - 50) {
                newX = 200;
                newY = lastCup.y - newH - 30;
            }

            // Kiểm tra trạng thái hiển thị: lấy từ cốc cuối cùng hoặc từ bình
            const inheritShowUnit = cups.length > 0 ? lastCup.showUnit : bottle.showUnit;
            const inheritUnit = cups.length > 0 ? lastCup.unit : bottle.unit;

            const newCup = {
                x: newX,
                y: newY,
                w: newW,
                h: newH,
                capacity: newCapacity,
                fill: 0,
                dragging: false,
                offsetX: 0,
                offsetY: 0,
                showUnit: inheritShowUnit,
                showScale: type === 'measuring',
                type: type,
                unit: inheritUnit,
                justCreated: true
            };

            cups.push(newCup);
            updateSettingsPanel();
            updateAddCupButton();
        }

        function removeCup(index) {
            if (cups.length > 1) {
                cups.splice(index, 1);
                updateSettingsPanel();
                updateAddCupButton();
            } else {
                alert("⚠️ Phải có ít nhất 1 cốc!");
            }
        }

        function updateAddCupButton() {
            const btn = document.getElementById("btnAddCup");
            const btnMeasuring = document.getElementById("btnAddMeasuringCup");
            const totalCups = cups.length;
            btn.textContent = `Thêm cốc thường (${totalCups}/5)`;
            btnMeasuring.textContent = `📏 Thêm cốc đo 1L (${totalCups}/5)`;

            if (totalCups >= 5) {
                btn.disabled = true;
                btnMeasuring.disabled = true;
            } else {
                btn.disabled = false;
                btnMeasuring.disabled = false;
            }
        }

        function updateSettingsPanel() {
            const normalContainer = document.getElementById("cupsSettingsContainer");
            const measuringContainer = document.getElementById("measuringCupsSettingsContainer");
            normalContainer.innerHTML = "";
            measuringContainer.innerHTML = "";

            const normalCups = cups.filter(c => c.type === 'normal');
            const measuringCups = cups.filter(c => c.type === 'measuring');

            // Cốc thường
            if (normalCups.length === 0) {
                normalContainer.innerHTML =
                    '<p style="color: #718096; font-size: 13px; padding: 8px;">Chưa có cốc thường nào</p>';
            } else {
                //Nút đổi đơn vị hàng loạt
                const bulkUnitBtn = document.createElement("button");
                bulkUnitBtn.className = "hide-all-btn";
                bulkUnitBtn.style.marginBottom = "8px";
                const currentUnit = normalCups[0].unit || 'l';
                bulkUnitBtn.textContent = currentUnit === 'l' ? "🔄 Đổi sang ml (cốc thường)" :
                    "🔄 Đổi sang lít (cốc thường)";
                if (currentUnit === 'ml') {
                    bulkUnitBtn.classList.add('ml-state');
                }
                bulkUnitBtn.onclick = () => {
                    const currentUnit = normalCups[0].unit || 'l';
                    const newUnit = currentUnit === 'l' ? 'ml' : 'l';
                    normalCups.forEach(c => c.unit = newUnit);
                    applySettings();
                    updateSettingsPanel();
                };
                normalContainer.appendChild(bulkUnitBtn);


                normalCups.forEach((cup, localIndex) => {
                    const globalIndex = cups.indexOf(cup);
                    normalContainer.appendChild(createCupSettingItem(cup, globalIndex, localIndex + 1));
                });
            }

            // Cốc đo
            if (measuringCups.length === 0) {
                measuringContainer.innerHTML =
                    '<p style="color: #718096; font-size: 13px; padding: 8px;">Chưa có cốc đo nào</p>';
            } else {

                const bulkUnitBtn = document.createElement("button");
                bulkUnitBtn.className = "hide-all-btn";
                bulkUnitBtn.style.marginBottom = "8px";
                const currentUnit = measuringCups[0].unit || 'l';
                bulkUnitBtn.textContent = currentUnit === 'l' ? "🔄 Đổi sang ml (cốc đo)" : "🔄 Đổi sang lít (cốc đo)";
                if (currentUnit === 'ml') {
                    bulkUnitBtn.classList.add('ml-state');
                }
                bulkUnitBtn.onclick = () => {
                    const currentUnit = measuringCups[0].unit || 'l';
                    const newUnit = currentUnit === 'l' ? 'ml' : 'l';
                    measuringCups.forEach(c => c.unit = newUnit);
                    applySettings();
                    updateToggleButtonText();
                };
                measuringContainer.appendChild(bulkUnitBtn);


                measuringCups.forEach((cup, localIndex) => {
                    const globalIndex = cups.indexOf(cup);
                    measuringContainer.appendChild(createCupSettingItem(cup, globalIndex, localIndex + 1));
                });
            }

            // Cập nhật text của nút toggle
            updateToggleButtonText();
        }

        function updateToggleButtonText() {
            const btn = document.getElementById("toggleAllUnits");
            const allHidden = bottle.showUnit === false && cups.every(c => c.showUnit === false);
            if (allHidden) {
                btn.textContent = "👁️‍🗨️ Hiện tất cả đơn vị đo";
                btn.classList.add("hidden-state"); // ← THÊM class màu cam
            } else {
                btn.textContent = "👁️ Ẩn tất cả đơn vị đo";
                btn.classList.remove("hidden-state"); // ← Bỏ class màu cam
            }
        }

        function createCupSettingItem(cup, globalIndex, displayIndex) {
            const div = document.createElement("div");
            div.className = "cup-item";

            const header = document.createElement("div");
            header.className = "cup-header";
            header.style.cursor = "pointer";

            const cupName = document.createElement("span");
            const cupTypeText = cup.type === 'measuring' ? 'Cốc đo' : 'Cốc';
            cupName.textContent = `${cupTypeText} ${displayIndex}`;

            const cupInfo = document.createElement("span");
            cupInfo.style.fontSize = "13px";
            cupInfo.style.color = "#718096";
            const cupUnit = cup.unit || 'l';
            const displayFill = cupUnit === "l" ? (cup.fill / 1000).toFixed(1) : Math.round(cup.fill);
            const displayCapacity = cupUnit === "l" ? (cup.capacity / 1000).toFixed(1) : cup.capacity;
            cupInfo.textContent = `${displayFill}${cupUnit} / ${displayCapacity}${cupUnit}`;
            header.appendChild(cupName);
            header.appendChild(cupInfo);

            const details = document.createElement("div");
            details.className = "cup-details";

            // Chọn đơn vị
            const unitLabel = document.createElement("label");
            unitLabel.textContent = "Đơn vị đo:";
            const unitSelect = document.createElement("select");
            unitSelect.id = `cup${globalIndex}UnitSelect`;
            unitSelect.innerHTML = `
    <option value="ml">Mililit (ml)</option>
    <option value="l">Lít (l)</option>
`;
            unitSelect.value = cup.unit || 'l';
            unitSelect.addEventListener('change', (e) => {
                cup.unit = e.target.value;
                settingsChanged = true;
                updateSettingsPanel();
            });
            details.appendChild(unitLabel);
            details.appendChild(unitSelect);

            const fillLabel = document.createElement("label");
            fillLabel.textContent = "Mức nước hiện tại:";

            const fillInput = document.createElement("input");
            fillInput.type = "number";
            fillInput.id = `cup${globalIndex}FillInput`;
            fillInput.value = cupUnit === "l" ? (cup.fill / 1000).toFixed(2) : Math.round(cup
                .fill);
            fillInput.min = "0";
            fillInput.max = cupUnit === "l" ? (cup.capacity / 1000).toFixed(2) : cup.capacity;
            fillInput.step = cupUnit === "l" ? "0.01" : "1";
            fillInput.addEventListener('input', () => settingsChanged = true);

            details.appendChild(fillLabel);
            details.appendChild(fillInput);

            // Dung tích - chỉ cho phép chỉnh sửa nếu không phải cốc đo 1L
            if (cup.type !== 'measuring') {
                const capacityLabel = document.createElement("label");
                capacityLabel.textContent = "Dung tích tối đa:";
                capacityLabel.style.marginTop = "8px";

                const capacityInput = document.createElement("input");
                capacityInput.type = "number";
                capacityInput.id = `cup${globalIndex}CapacityInput`;
                capacityInput.value = cupUnit === "l" ? (cup.capacity / 1000).toFixed(2) : cup.capacity;
                capacityInput.min = "1";
                capacityInput.step = cupUnit === "l" ? "0.01" : "1";
                capacityInput.addEventListener('input', () => settingsChanged = true);

                details.appendChild(capacityLabel);
                details.appendChild(capacityInput);
            } else {
                const capacityNote = document.createElement("p");
                capacityNote.style.fontSize = "12px";
                capacityNote.style.color = "#718096";
                capacityNote.style.marginTop = "8px";
                capacityNote.style.fontStyle = "italic";
                capacityNote.textContent = "Dung tích cố định: 1000ml (1L)";
                details.appendChild(capacityNote);
            }

            // Checkbox hiển thị đơn vị
            const showUnitLabel = document.createElement("label");
            showUnitLabel.className = "checkbox-label";
            const showUnitCheckbox = document.createElement("input");
            showUnitCheckbox.type = "checkbox";
            showUnitCheckbox.id = `cup${globalIndex}ShowUnit`;
            showUnitCheckbox.checked = cup.showUnit;
            showUnitCheckbox.addEventListener('change', () => {
                settingsChanged = true;
                cup.showUnit = showUnitCheckbox.checked;
            });
            const showUnitText = document.createElement("span");
            showUnitText.textContent = "Hiển thị đơn vị đo";
            showUnitLabel.appendChild(showUnitCheckbox);
            showUnitLabel.appendChild(showUnitText);
            details.appendChild(showUnitLabel);

            // Checkbox hiển thị vạch chia (chỉ cho cốc đo)
            if (cup.type === 'measuring') {
                const showScaleLabel = document.createElement("label");
                showScaleLabel.className = "checkbox-label";
                const showScaleCheckbox = document.createElement("input");
                showScaleCheckbox.type = "checkbox";
                showScaleCheckbox.id = `cup${globalIndex}ShowScale`;
                showScaleCheckbox.checked = cup.showScale;
                showScaleCheckbox.addEventListener('change', () => {
                    settingsChanged = true;
                    cup.showScale = showScaleCheckbox.checked;
                });
                const showScaleText = document.createElement("span");
                showScaleText.textContent = "Hiển thị vạch chia";
                showScaleLabel.appendChild(showScaleCheckbox);
                showScaleLabel.appendChild(showScaleText);
                details.appendChild(showScaleLabel);
            }

            if (cups.length > 1) {
                const deleteBtn = document.createElement("button");
                deleteBtn.className = "delete-btn";
                deleteBtn.textContent = "🗑 Xóa cốc";
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeCup(globalIndex);
                    settingsChanged = true;
                };
                details.appendChild(deleteBtn);
            }

            div.appendChild(header);
            div.appendChild(details);

            header.addEventListener("click", () => {
                const wasExpanded = div.classList.contains("expanded");

                document.querySelectorAll(".cup-item").forEach(item => {
                    item.classList.remove("expanded");
                });

                if (!wasExpanded) {
                    div.classList.add("expanded");
                }
            });

            return div;
        }

        // Event Listeners
        document.getElementById("btnAddCup").addEventListener("click", () => addCup('normal'));
        document.getElementById("btnAddMeasuringCup").addEventListener("click", () => addCup('measuring'));

        document.getElementById("resetBtn").addEventListener("click", () => {
            bottle = JSON.parse(JSON.stringify(initialState.bottle));
            cups = JSON.parse(JSON.stringify(initialState.cups));
            if (bottleEmpty.complete) setSizeKeepRatio(bottle, bottleEmpty, 210);
            if (cupEmpty.complete) {
                cups.forEach(c => {
                    if (c.type === 'normal') {
                        setSizeKeepRatio(c, cupEmpty, 130);
                    }
                });
            }
            if (measuredCupEmpty.complete) {
                cups.forEach(c => {
                    if (c.type === 'measuring') {
                        setSizeKeepRatio(c, measuredCupEmpty, 160);
                    }
                });
            }
            updateSettingsPanel();
            updateAddCupButton();
            settingsChanged = false;
        });

        document.getElementById("settingsBtn").addEventListener("click", () => {
            const panel = document.getElementById("settingsPanel");
            const overlay = document.getElementById("settingsOverlay");
            const isOpen = panel.classList.contains("active");

            if (isOpen) {
                // Đang mở, muốn đóng
                if (settingsChanged) {
                    // Có thay đổi chưa lưu
                    document.getElementById("confirmModal").classList.add("active");
                } else {
                    // Không có thay đổi, đóng với animation
                    panel.classList.remove("active");
                    overlay.classList.remove("active");
                }
            } else {
                // Đang đóng, muốn mở
                savedState = {
                    bottle: JSON.parse(JSON.stringify(bottle)),
                    cups: JSON.parse(JSON.stringify(cups)),
                };
                settingsChanged = false;

                // Hiện overlay trước, sau đó hiện panel
                overlay.classList.add("active");
                // Delay nhỏ để animation mượt hơn
                setTimeout(() => {
                    panel.classList.add("active");
                }, 10);

                document.getElementById("bottleUnitSelect").value = bottle.unit || 'l';
                const bottleUnit = bottle.unit || 'l';
                document.getElementById("bottleFillInput").value = bottleUnit === "l" ? (bottle.fill / 1000)
                    .toFixed(2) : Math.round(bottle.fill);
                document.getElementById("bottleFillInput").step = bottleUnit === "l" ? "0.01" : "1";
                document.getElementById("bottleCapacityInput").value = bottleUnit === "l" ? (bottle.capacity /
                    1000).toFixed(2) : bottle.capacity;
                document.getElementById("bottleCapacityInput").step = bottleUnit === "l" ? "0.01" : "1";
                document.getElementById("bottleShowUnit").checked = bottle.showUnit;
                updateSettingsPanel();
            }
        });
        // Modal confirm buttons
        document.getElementById("modalConfirm").addEventListener("click", () => {
            // Lưu thay đổi
            applySettings();

            document.getElementById("confirmModal").classList.remove("active");
            document.getElementById("settingsPanel").classList.remove("active");
            document.getElementById("settingsOverlay").classList.remove("active");
            settingsChanged = false;
        });

        document.getElementById("modalCancel").addEventListener("click", () => {
            // Quay lại panel để lưu
            document.getElementById("confirmModal").classList.remove("active");
        });

        document.getElementById("toggleAllUnits").addEventListener("click", () => {
            const btn = document.getElementById("toggleAllUnits");
            const allHidden = bottle.showUnit === false && cups.every(c => c.showUnit === false);

            if (allHidden) {
                // Hiện tất cả
                bottle.showUnit = true;
                cups.forEach(c => c.showUnit = true);
                document.getElementById("bottleShowUnit").checked = true;
                cups.forEach((c, i) => {
                    const checkbox = document.getElementById(`cup${i}ShowUnit`);
                    if (checkbox) checkbox.checked = true;
                });
                btn.textContent = "👁️ Ẩn tất cả đơn vị đo";
                btn.classList.remove("hidden-state");
            } else {
                // Ẩn tất cả
                bottle.showUnit = false;
                cups.forEach(c => c.showUnit = false);
                document.getElementById("bottleShowUnit").checked = false;
                cups.forEach((c, i) => {
                    const checkbox = document.getElementById(`cup${i}ShowUnit`);
                    if (checkbox) checkbox.checked = false;
                });
                btn.textContent = "👁️‍🗨️ Hiện tất cả đơn vị đo";
                btn.classList.remove("hidden-state");
            }
            applySettings();
            updateToggleButtonText(); // Cập nhật text sau khi thay đổi
        });

        function applySettings() {
            const bottleUnit = bottle.unit || 'l';
            const bottleFillValue = parseFloat(document.getElementById("bottleFillInput").value);
            const bottleCapacityValue = parseFloat(document.getElementById("bottleCapacityInput").value);
            bottle.showUnit = document.getElementById("bottleShowUnit").checked;

            if (!isNaN(bottleCapacityValue) && bottleCapacityValue > 0) {
                bottle.capacity = bottleUnit === "l" ? bottleCapacityValue * 1000 : bottleCapacityValue;
            }
            if (!isNaN(bottleFillValue)) {
                bottle.fill = Math.max(0, Math.min(bottle.capacity, bottleUnit === "l" ? bottleFillValue * 1000 :
                    bottleFillValue));
            }

            cups.forEach((c, i) => {
                const cupUnit = c.unit || 'l';
                const fillInput = document.getElementById(`cup${i}FillInput`);
                const capacityInput = document.getElementById(`cup${i}CapacityInput`);
                const showUnitCheckbox = document.getElementById(`cup${i}ShowUnit`);
                const showScaleCheckbox = document.getElementById(`cup${i}ShowScale`);

                // Cốc đo 1L không cho phép thay đổi dung tích
                if (capacityInput && c.type !== 'measuring') {
                    const capacityVal = parseFloat(capacityInput.value);
                    if (!isNaN(capacityVal) && capacityVal > 0) {
                        c.capacity = cupUnit === "l" ? capacityVal * 1000 : capacityVal;
                    }
                }

                if (fillInput) {
                    const fillVal = parseFloat(fillInput.value);
                    if (!isNaN(fillVal)) {
                        c.fill = Math.max(0, Math.min(c.capacity, cupUnit === "l" ? fillVal * 1000 :
                            fillVal));
                    }
                }
                if (showUnitCheckbox) {
                    c.showUnit = showUnitCheckbox.checked;
                }
                if (showScaleCheckbox) {
                    c.showScale = showScaleCheckbox.checked;
                }
            });

            settingsChanged = false;
            updateSettingsPanel();
        }

        document.getElementById("applySettings").addEventListener("click", () => {
            applySettings();
            // Đóng với animation
            document.getElementById("settingsPanel").classList.remove("active");
            document.getElementById("settingsOverlay").classList.remove("active");
        });

        // Các input trong phần bình nước
        document.getElementById("bottleFillInput").addEventListener('input', () => settingsChanged = true);
        document.getElementById("bottleCapacityInput").addEventListener('input', () => settingsChanged = true);
        document.getElementById("bottleShowUnit").addEventListener('change', () => {
            settingsChanged = true;
            bottle.showUnit = document.getElementById("bottleShowUnit").checked;
        });

        document.getElementById("settingsPanel").addEventListener("keydown", (e) => {
            if (e.key === "Enter" && e.target.tagName === "INPUT") {
                e.preventDefault();
                applySettings();
            }
        });

        document.getElementById("settingsPanel").addEventListener("change", (e) => {
            if (e.target.id === "bottleUnitSelect") {
                bottle.unit = e.target.value;
                const bottleUnit = bottle.unit;

                // Cập nhật input bình
                document.getElementById("bottleFillInput").value = bottleUnit === "l" ? (bottle.fill / 1000)
                    .toFixed(2) : Math.round(bottle.fill);
                document.getElementById("bottleFillInput").step = bottleUnit === "l" ? "0.01" : "1";
                document.getElementById("bottleFillInput").max = bottleUnit === "l" ? (bottle.capacity / 1000)
                    .toFixed(2) : bottle.capacity;
                document.getElementById("bottleCapacityInput").value = bottleUnit === "l" ? (bottle.capacity /
                    1000).toFixed(2) : bottle.capacity;
                document.getElementById("bottleCapacityInput").step = bottleUnit === "l" ? "0.01" : "1";

                settingsChanged = true;
            }
        });

        // Click vào overlay để đóng settings
        document.getElementById("settingsOverlay").addEventListener("click", () => {
            const panel = document.getElementById("settingsPanel");
            const overlay = document.getElementById("settingsOverlay");

            if (settingsChanged) {
                // Có thay đổi chưa lưu - hiện modal xác nhận
                document.getElementById("confirmModal").classList.add("active");
            } else {
                // Không có thay đổi - đóng với animation
                panel.classList.remove("active");
                overlay.classList.remove("active");
            }
        });
        canvas.addEventListener("mousedown", e => {
            const mx = e.offsetX,
                my = e.offsetY;
            if (mx > bottle.x && mx < bottle.x + bottle.w && my > bottle.y && my < bottle.y + bottle.h) {
                bottle.dragging = true;
                bottle.offsetX = mx - bottle.x;
                bottle.offsetY = my - bottle.y;

                // Reset tất cả flag justCreated khi chạm vào bình
                cups.forEach(c => c.justCreated = false);

                return;
            }
            for (let i = cups.length - 1; i >= 0; i--) {
                const c = cups[i];
                if (mx > c.x && mx < c.x + c.w && my > c.y && my < c.y + c.h) {
                    c.dragging = true;
                    c.offsetX = mx - c.x;
                    c.offsetY = my - c.y;
                    break;
                }
            }
        });

        canvas.addEventListener("mousemove", e => {
            const mx = e.offsetX,
                my = e.offsetY;
            if (bottle.dragging) {
                bottle.x = mx - bottle.offsetX;
                bottle.y = my - bottle.offsetY;

                // Reset tất cả flag justCreated khi di chuyển bình
                cups.forEach(c => c.justCreated = false);
            }
            cups.forEach(c => {
                if (c.dragging) {
                    c.x = mx - c.offsetX;
                    c.y = my - c.offsetY;
                }
            });
        });

        canvas.addEventListener("mouseup", () => {
            bottle.dragging = false;
            cups.forEach(c => c.dragging = false);
        });

        // Kiểm tra xem user đã xem hướng dẫn chưa
        const hasSeenTutorial = localStorage.getItem('hasSeenTutorial');
        const toastBanner = document.getElementById('toastBanner');
        const helpModal = document.getElementById('helpModal');

        // Hiển thị toast nếu lần đầu
        if (!hasSeenTutorial) {
            setTimeout(() => {
                toastBanner.classList.add('show');
            }, 500); // Delay 0.5s sau khi load
        }

        // Nút "Xem hướng dẫn" trên toast
        document.getElementById('toastHelpBtn').addEventListener('click', () => {
            helpModal.classList.add('active');
            toastBanner.classList.remove('show');
        });

        // Nút "Đã hiểu" trên toast
        document.getElementById('toastDismissBtn').addEventListener('click', () => {
            toastBanner.classList.remove('show');
            localStorage.setItem('hasSeenTutorial', 'true');
        });

        // Nút "×" đóng toast
        document.getElementById('toastCloseBtn').addEventListener('click', () => {
            toastBanner.classList.remove('show');
        });

        // Nút "📖 Hướng dẫn" trong header
        document.getElementById('helpBtn').addEventListener('click', () => {
            helpModal.classList.add('active');
        });

        // Nút "×" đóng help modal
        document.getElementById('closeHelpBtn').addEventListener('click', () => {
            helpModal.classList.remove('active');
        });

        // Click vào overlay để đóng help modal
        helpModal.addEventListener('click', (e) => {
            if (e.target === helpModal) {
                helpModal.classList.remove('active');
            }
        });

        // Đánh dấu đã xem tutorial khi mở help panel
        helpModal.addEventListener('click', () => {
            if (!localStorage.getItem('hasSeenTutorial')) {
                localStorage.setItem('hasSeenTutorial', 'true');
            }
        });
    </script>
</body>

</html>