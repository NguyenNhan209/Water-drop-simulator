<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <title>K√©o th·∫£ b√¨nh ƒë·ªÉ r√≥t v√†o c·ªëc</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 16px 24px;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #1a202c;
            margin: 0;
        }

        #controls {
            display: flex;
            gap: 12px;
        }

        button {
            padding: 10px 20px;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            cursor: not-allowed !important;
            opacity: 0.5 !important;
            transform: none !important;
        }

        #resetBtn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 2px 8px rgba(245, 87, 108, 0.3);
        }

        #resetBtn:hover {
            box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);
        }

        #btnAddCup {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            box-shadow: 0 2px 8px rgba(79, 172, 254, 0.3);
        }

        #btnAddCup:hover {
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.4);
        }

        #btnAddMeasuringCup {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            box-shadow: 0 2px 8px rgba(250, 112, 154, 0.3);
        }

        #btnAddMeasuringCup:hover {
            box-shadow: 0 4px 12px rgba(250, 112, 154, 0.4);
        }

        .canvas-wrapper {
            position: relative;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        canvas {
            width: 100%;
            height: 70vh;
            border-radius: 12px;
            display: block;
            background: linear-gradient(180deg, #ffffff 0%, #f7fafc 100%);
            cursor: grab;
        }

        canvas:active {
            cursor: grabbing;
        }

        #settingsPanel {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            max-height: 80vh;
            overflow-y: auto;
            min-width: 320px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        #settingsPanel h4 {
            margin: 0 0 16px 0;
            color: #1a202c;
            font-size: 18px;
            font-weight: 600;
        }

        #settingsPanel label {
            display: block;
            margin-top: 12px;
            color: #4a5568;
            font-size: 14px;
            font-weight: 500;
        }

        #settingsPanel input,
        #settingsPanel select {
            width: 100%;
            padding: 8px 12px;
            margin-top: 6px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        #settingsPanel input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        #settingsPanel input:focus,
        #settingsPanel select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #settingsPanel select {
            cursor: pointer;
        }

        #settingsPanel hr {
            margin: 16px 0;
            border: none;
            border-top: 1px solid #e2e8f0;
        }

        #cupsSettingsContainer,
        #measuringCupsSettingsContainer {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .cup-item {
            padding: 12px;
            background: #f7fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cup-item:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .cup-item.expanded {
            background: #fff;
            border-color: #667eea;
            cursor: default;
        }

        .cup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            color: #1a202c;
            font-size: 14px;
            padding: 4px 0;
        }

        .cup-details {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
        }

        .cup-item.expanded .cup-details {
            display: block;
        }

        .cup-item.expanded .cup-header {
            font-weight: 600;
            color: #667eea;
        }

        #cupsSettingsContainer label,
        #measuringCupsSettingsContainer label {
            margin: 0 0 4px 0;
            font-size: 12px;
            color: #718096;
        }

        .delete-btn {
            margin-top: 8px;
            width: 100%;
            padding: 8px;
            font-size: 13px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            margin-top: 8px;
            cursor: pointer;
            font-size: 13px;
        }

        .settings-section {
            padding: 12px;
            background: #f7fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            margin-top: 8px;
        }

        .hide-all-btn {
            width: 100%;
            margin-top: 8px;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #1a202c;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 16px;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .modal-content h3 {
            margin: 0 0 12px 0;
            color: #1a202c;
            font-size: 18px;
        }

        .modal-content p {
            margin: 0 0 20px 0;
            color: #4a5568;
            line-height: 1.5;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-buttons button {
            padding: 8px 16px;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üåä Tr√≤ ch∆°i r√≥t n∆∞·ªõc</h1>
            <div id="controls">
                <button id="resetBtn">‚Ü∫ Reset</button>
                <button id="btnAddCup">+ C·ªëc th∆∞·ªùng</button>
                <button id="btnAddMeasuringCup">üìè C·ªëc ƒëo 1L</button>
                <button id="settingsBtn">‚öô C√†i ƒë·∫∑t</button>
            </div>
        </div>

        <div class="canvas-wrapper">
            <canvas id="world"></canvas>
        </div>
    </div>

    <div id="settingsPanel" style="display:none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h4 style="margin: 0;">‚öôÔ∏è C√†i ƒë·∫∑t</h4>
            <button id="applySettings" style="width: auto; padding: 8px 16px; font-size: 13px;">‚úì √Åp d·ª•ng</button>
        </div>

        <hr>

        <label>
            ƒê∆°n v·ªã ƒëo m·∫∑c ƒë·ªãnh
            <select id="unitSelect">
                <option value="ml">Mililit (ml)</option>
                <option value="l">L√≠t (l)</option>
            </select>
        </label>

        <button class="hide-all-btn" id="toggleAllUnits">üëÅÔ∏è ·∫®n t·∫•t c·∫£ ƒë∆°n v·ªã ƒëo</button>

        <hr>

        <label style="font-size: 14px; font-weight: 600; color: #1a202c; margin-bottom: 8px;">
            üç∂ B√¨nh n∆∞·ªõc
        </label>
        <div class="settings-section">
            <label style="font-size: 12px; color: #718096;">
                M·ª©c n∆∞·ªõc hi·ªán t·∫°i
                <input type="number" id="bottleFillInput" />
            </label>
            <label style="font-size: 12px; color: #718096;">
                Dung t√≠ch t·ªëi ƒëa
                <input type="number" id="bottleCapacityInput" />
            </label>
            <label class="checkbox-label">
                <input type="checkbox" id="bottleShowUnit" checked />
                <span>Hi·ªÉn th·ªã ƒë∆°n v·ªã ƒëo</span>
            </label>
        </div>

        <hr>

        <label style="font-size: 14px; font-weight: 600; color: #1a202c; margin-bottom: 8px;">
            ü•§ C·ªëc th∆∞·ªùng
        </label>
        <div id="cupsSettingsContainer" style="margin-top: 8px;"></div>

        <hr>

        <label style="font-size: 14px; font-weight: 600; color: #1a202c; margin-bottom: 8px;">
            üìè C·ªëc ƒëo 1 l√≠t
        </label>
        <div id="measuringCupsSettingsContainer" style="margin-top: 8px;"></div>
    </div>

    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <h3>‚ö†Ô∏è Thay ƒë·ªïi ch∆∞a ƒë∆∞·ª£c l∆∞u</h3>
            <p>B·∫°n ch∆∞a l∆∞u thay ƒë·ªïi. B·∫°n c√≥ mu·ªën h·ªßy c√°c thay ƒë·ªïi v·ª´a th·ª±c hi·ªán kh√¥ng?</p>
            <div class="modal-buttons">
                <button id="modalCancel">Kh√¥ng (Quay l·∫°i)</button>
                <button id="modalConfirm" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">C√≥ (H·ªßy
                    thay ƒë·ªïi)</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById("world");
        const ctx = canvas.getContext("2d");

        // Bi·∫øn to√†n c·ª•c
        let unit = "l";
        let settingsChanged = false;
        let bottle = {
            x: 550,
            y: 80,
            w: 120,
            h: 220,
            capacity: 2000,
            fill: 2000,
            pouring: false,
            angle: 0,
            dragging: false,
            offsetX: 0,
            offsetY: 0,
            showUnit: true
        };

        let cups = [{
            x: 200,
            y: 150,
            w: 120,
            h: 180,
            capacity: 1000,
            fill: 0,
            dragging: false,
            offsetX: 0,
            offsetY: 0,
            showUnit: true,
            showScale: false,
            type: 'normal'
        }];

        // L∆∞u state ban ƒë·∫ßu v√† state t·∫°m th·ªùi
        let savedState = null;
        let tempState = null;

        function saveInitialState() {
            return {
                bottle: JSON.parse(JSON.stringify(bottle)),
                cups: JSON.parse(JSON.stringify(cups)),
                unit: unit
            };
        }
        let initialState = saveInitialState();

        // Images
        const cupEmpty = new Image();
        const cupFull = new Image();
        const bottleEmpty = new Image();
        const bottleFull = new Image();
        const measuredCupEmpty = new Image();
        const measuredCupFull = new Image();
        let loaded = 0;
        let t = 0;

        function onLoad() {
            loaded++;
            if (loaded === 6) {
                animate();
                updateAddCupButton();
            }
        }

        cupEmpty.onload = () => {
            cups.forEach(cup => {
                if (cup.type === 'normal') {
                    setSizeKeepRatio(cup, cupEmpty, 130);
                }
            });
            onLoad();
        };
        cupFull.onload = onLoad;
        bottleEmpty.onload = () => {
            setSizeKeepRatio(bottle, bottleEmpty, 210);
            onLoad();
        };
        bottleFull.onload = onLoad;
        measuredCupEmpty.onload = () => {
            cups.forEach(cup => {
                if (cup.type === 'measuring') {
                    setSizeKeepRatio(cup, measuredCupEmpty, 160);
                }
            });
            onLoad();
        };
        measuredCupFull.onload = onLoad;

        cupEmpty.src = "res/cup_empty.png?v=20251014234757";
        cupFull.src = "res/cup_full.png?v=20251014234757";
        bottleEmpty.src = "res/bottle_empty.png?v=20251014234757";
        bottleFull.src = "res/bottle_full.png?v=20251014234757";
        measuredCupEmpty.src = "res/measured_cup_empty.png?v=20251014234757";
        measuredCupFull.src = "res/measured_cup_full.png?v=20251014234757";

        function resizeCanvas() {
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
            cups.forEach((cup, i) => {
                if (cup.type === 'measuring' && cup.showScale) {
                    cup.x = canvas.width * 0.9 + i * 100;
                    cup.y = canvas.height * 0.4;
                } else {
                    cup.x = canvas.width * 0.2 + i * 150;
                    cup.y = canvas.height * 0.6;
                }
            });
            bottle.x = canvas.width * 0.6;
            bottle.y = canvas.height * 0.2;
        }
        resizeCanvas();
        window.addEventListener("resize", resizeCanvas);

        function setSizeKeepRatio(obj, img, targetHeight) {
            const ratio = img.naturalWidth / img.naturalHeight;
            obj.h = targetHeight;
            obj.w = obj.h * ratio;
        }

        function drawCup(cup, index, highlight = false) {
            if (highlight) {
                ctx.save();
                ctx.fillStyle = "rgba(0,200,255,0.15)";
                ctx.fillRect(cup.x - 10, cup.y - 10, cup.w + 20, cup.h + 20);
                ctx.restore();
            }

            // V·∫Ω c·ªëc
            if (cupEmpty.complete) {
                if (cup.type === 'measuring' && cup.showScale) {
                    ctx.drawImage(measuredCupEmpty, cup.x, cup.y, cup.w, cup.h)
                } else {
                    ctx.drawImage(cupEmpty, cup.x, cup.y, cup.w, cup.h)
                }
            } else {
                ctx.strokeStyle = "#2c3e50";
                ctx.strokeRect(cup.x, cup.y, cup.w, cup.h);
            }

            // V·∫Ω n∆∞·ªõc
            if (cup.fill > 0) {
                const percent = cup.fill / cup.capacity;
                const waterHeight = cup.h * percent;
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(cup.x, cup.y + cup.h - waterHeight);

                if (cup.type === 'measuring' && cup.showScale) {
                    for (let x = 0; x <= cup.w; x += 5) {
                        const y = Math.sin((x / 50) * Math.PI * 2 + t) * 2;
                        ctx.lineTo(cup.x + x, cup.y + cup.h - waterHeight + y);
                    }
                } else {
                    for (let x = 0; x <= cup.w; x += 5) {
                        const y = Math.sin((x / 50) * Math.PI * 2 + t) * 6;
                        ctx.lineTo(cup.x + x, cup.y + cup.h - waterHeight + y);
                    }
                }

                ctx.lineTo(cup.x + cup.w, cup.y + cup.h);
                ctx.lineTo(cup.x, cup.y + cup.h);
                ctx.closePath();
                ctx.clip();
                if (cupFull.complete) {
                    if (cup.type === 'measuring' && cup.showScale) {
                        ctx.drawImage(measuredCupFull, cup.x, cup.y, cup.w, cup.h)
                    } else {
                        ctx.drawImage(cupFull, cup.x, cup.y, cup.w, cup.h)
                    }
                } else {
                    ctx.fillStyle = "rgba(0,150,255,0.6)";
                    ctx.fillRect(cup.x, cup.y + cup.h - waterHeight, cup.w, waterHeight);
                }
                ctx.restore();
            }

            // Hi·ªÉn th·ªã th√¥ng tin
            if (cup.showUnit) {
                ctx.fillStyle = "#2c3e50";
                ctx.font = "14px sans-serif";
                const displayFill = unit === "l" ? (cup.fill / 1000).toFixed(2) : Math.round(cup.fill);
                const displayCapacity = unit === "l" ? (cup.capacity / 1000).toFixed(2) : cup.capacity;
                const cupType = cup.type === 'measuring' ? 'C·ªëc ƒëo' : 'C·ªëc';
                const normalCupIndex = cups.filter((c, i) => c.type === cup.type && cups.indexOf(c) <= cups.indexOf(
                    cup)).length;
                ctx.fillText(`${cupType} ${normalCupIndex}: ${displayFill} / ${displayCapacity} ${unit}`, cup.x, cup.y +
                    cup.h + 20);
            }
        }

        function drawBottle() {
            ctx.save();
            ctx.translate(bottle.x + bottle.w / 2, bottle.y + bottle.h / 2);
            ctx.rotate(bottle.angle);
            ctx.drawImage(bottleEmpty, -bottle.w / 2, -bottle.h / 2, bottle.w, bottle.h);

            if (bottle.fill > 0) {
                const percent = bottle.fill / bottle.capacity;
                const waterHeight = bottle.h * percent;
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(-bottle.w / 2, -bottle.h / 2 + (bottle.h - waterHeight));
                for (let x = 0; x <= bottle.w; x += 5) {
                    const y = Math.sin((x / 40) * Math.PI * 2 + t) * 5;
                    ctx.lineTo(-bottle.w / 2 + x, -bottle.h / 2 + (bottle.h - waterHeight) + y);
                }
                ctx.lineTo(bottle.w / 2, bottle.h / 2);
                ctx.lineTo(-bottle.w / 2, bottle.h / 2);
                ctx.closePath();
                ctx.clip();
                ctx.drawImage(bottleFull, -bottle.w / 2, -bottle.h / 2, bottle.w, bottle.h);
                ctx.restore();
            }
            ctx.restore();

            // V·∫Ω d√≤ng n∆∞·ªõc
            if (bottle.pouring && bottle.fill > 0) {
                const cx = bottle.x + bottle.w / 2;
                const cy = bottle.y + bottle.h / 2;
                const cos = Math.cos(bottle.angle);
                const sin = Math.sin(bottle.angle);
                const mouthX = cx - bottle.w / 2 * cos + bottle.h / 2 * sin;
                const mouthY = cy - bottle.w / 2 * sin - bottle.h / 2 * cos;

                let targetCup = null;
                let minDist = Infinity;
                cups.forEach(cup => {
                    const bottleCenterX = bottle.x + bottle.w / 2;
                    const cupCenterX = cup.x + cup.w / 2;
                    const isBottleOnRight = bottleCenterX > cupCenterX;

                    if (isNearCup(bottle, cup) && cup.fill < cup.capacity && isBottleOnRight) {
                        const dist = Math.hypot((bottle.x + bottle.w / 2) - (cup.x + cup.w / 2), (bottle.y +
                            bottle.h / 2) - (cup.y + cup.h / 2));
                        if (dist < minDist) {
                            minDist = dist;
                            targetCup = cup;
                        }
                    }
                });

                if (targetCup) {
                    const targetX = targetCup.x + targetCup.w / 2;
                    const targetY = targetCup.y;

                    const bottleCenterX = bottle.x + bottle.w / 2;
                    const bottleCenterY = bottle.y + bottle.h / 2;

                    // T√≠nh v·ªã tr√≠ mi·ªáng b√¨nh d·ª±a tr√™n g√≥c quay
                    const cos = Math.cos(bottle.angle);
                    const sin = Math.sin(bottle.angle);
                    // Mi·ªáng b√¨nh ·ªü ƒë·∫ßu tr√™n (ƒë·ªânh b√¨nh)
                    const mouthRelativeX = sin * bottle.h / 2;
                    const mouthRelativeY = -cos * bottle.h / 2;

                    const actualMouthX = bottleCenterX + mouthRelativeX;

                    // Ki·ªÉm tra: c·ªëc ph·∫£i n·∫±m v·ªÅ ph√≠a b√¨nh ƒëang nghi√™ng
                    const cupDirection = targetX - bottleCenterX; // D∆∞∆°ng = c·ªëc ·ªü b√™n ph·∫£i, √Çm = c·ªëc ·ªü b√™n tr√°i
                    const tiltDirection = mouthRelativeX; // D∆∞∆°ng = nghi√™ng ph·∫£i, √Çm = nghi√™ng tr√°i
                    const isSameDirection = (cupDirection * tiltDirection) > 0; // C√πng d·∫•u = c√πng h∆∞·ªõng

                    // Ki·ªÉm tra c√°c ƒëi·ªÅu ki·ªán
                    const angleInDegrees = bottle.angle * 180 / Math.PI;
                    const isBottleTilted = Math.abs(bottle.angle) > 0.17;
                    const isMouthAboveCup = mouthY < targetY + 50;

                    if (isBottleTilted && isMouthAboveCup && isSameDirection) {
                        const length = targetY - mouthY;

                        const gradient = ctx.createLinearGradient(mouthX, mouthY, targetX, targetY);
                        gradient.addColorStop(0, "rgba(0,150,255,0.8)");
                        gradient.addColorStop(0.5, "rgba(0,180,255,0.6)");
                        gradient.addColorStop(1, "rgba(0,200,255,0.2)");

                        ctx.beginPath();
                        for (let y = 0; y <= length; y += 5) {
                            const progress = y / length;
                            const xLerp = mouthX + (targetX - mouthX) * progress;
                            const yLerp = mouthY + (targetY - mouthY) * progress;
                            const offset = Math.sin((y / 25) * Math.PI * 2 + t) * 4;
                            const x = xLerp + offset - 10;
                            if (y === 0) ctx.moveTo(x, yLerp);
                            else ctx.lineTo(x, yLerp);
                        }
                        for (let y = length; y >= 0; y -= 5) {
                            const progress = y / length;
                            const xLerp = mouthX + (targetX - mouthX) * progress;
                            const yLerp = mouthY + (targetY - mouthY) * progress;
                            const offset = Math.sin((y / 25) * Math.PI * 2 + t) * 4;
                            ctx.lineTo(xLerp + offset + 10, yLerp);
                        }
                        ctx.closePath();
                        ctx.fillStyle = gradient;
                        ctx.fill();
                    }
                }
            }

            // Hi·ªÉn th·ªã th√¥ng tin b√¨nh
            if (bottle.showUnit) {
                ctx.fillStyle = "#2c3e50";
                ctx.font = "16px sans-serif";
                const displayFill = unit === "l" ? (bottle.fill / 1000).toFixed(2) : Math.round(bottle.fill);
                const displayCapacity = unit === "l" ? (bottle.capacity / 1000).toFixed(2) : bottle.capacity;
                ctx.fillText(`B√¨nh: ${displayFill} / ${displayCapacity} ${unit}`, bottle.x - 20, bottle.y + bottle.h +
                    50);
            }
        }

        function isNearCup(bottle, cup) {
            const margin = 50;
            return (bottle.x < cup.x + cup.w + margin &&
                bottle.x + bottle.w > cup.x - margin &&
                bottle.y < cup.y + cup.h + margin &&
                bottle.y + bottle.h > cup.y - margin);
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            let nearestCup = null;
            let minDistance = Infinity;
            cups.forEach(cup => {
                const bottleCenterX = bottle.x + bottle.w / 2;
                const cupCenterX = cup.x + cup.w / 2;
                const isBottleOnRight = bottleCenterX > cupCenterX;

                if (isNearCup(bottle, cup) && cup.fill < cup.capacity && isBottleOnRight) {
                    const distance = Math.hypot((bottle.x + bottle.w / 2) - (cup.x + cup.w / 2), (bottle.y +
                        bottle.h / 2) - (cup.y + cup.h / 2));
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestCup = cup;
                    }
                }
            });

            if (!bottle.dragging && nearestCup && bottle.fill > 0) {
                bottle.pouring = true;
            } else if (bottle.dragging || !nearestCup || bottle.fill <= 0) {
                bottle.pouring = false;
            }

            if (bottle.pouring && nearestCup) {
                const cx = bottle.x + bottle.w / 2;
                const cy = bottle.y + bottle.h / 2;
                const cupTargetX = nearestCup.x + nearestCup.w / 2;
                const cupTargetY = nearestCup.y;

                const dx = cupTargetX - cx;
                const dy = cupTargetY - cy;
                let targetAngle = Math.atan2(dy, dx) - Math.PI / 2;

                const minAngle = -Math.PI * 0.42;
                const maxAngle = -Math.PI * 0.08;

                targetAngle = Math.max(minAngle, Math.min(maxAngle, targetAngle));

                bottle.angle += (targetAngle - bottle.angle) * 0.1;

                const pourSpeed = 2;
                const actualPour = Math.min(pourSpeed, bottle.fill, nearestCup.capacity - nearestCup.fill);
                nearestCup.fill += actualPour;
                bottle.fill -= actualPour;

                if (nearestCup.fill >= nearestCup.capacity) {
                    nearestCup.fill = nearestCup.capacity;
                    bottle.pouring = false;
                }
            }

            if (!bottle.pouring) {
                bottle.angle += (0 - bottle.angle) * 0.1;
            }

            t += 0.05;
            cups.forEach((c, i) => drawCup(c, i, c === nearestCup));
            drawBottle();
            requestAnimationFrame(animate);
        }

        function addCup(type = 'normal') {
            if (cups.length >= 5) {
                alert("‚ö†Ô∏è Ch·ªâ c√≥ th·ªÉ t·∫°o t·ªëi ƒëa 5 c·ªëc!");
                return;
            }

            const baseCup = cups[0];
            const lastCup = cups[cups.length - 1];
            let newX = lastCup.x + lastCup.w + 35;
            let newY = lastCup.y;

            let newW, newH, newCapacity;

    if (type === 'measuring') {
        if (measuredCupEmpty.complete) {
            const ratio = measuredCupEmpty.naturalWidth / measuredCupEmpty.naturalHeight;
            newH = 160;
            newW = newH * ratio;
        } else {
            newW = 100;
            newH = 160;
        }
        newCapacity = 1000;
    } else {
        if (cupEmpty.complete) {
            const ratio = cupEmpty.naturalWidth / cupEmpty.naturalHeight;
            newH = 130;
            newW = newH * ratio;
        } else {
            newW = 120;
            newH = 130;
        }
        newCapacity = 1000;
    }

    if (newX + newW > canvas.width - 50) {
        newX = 200;
        newY = lastCup.y - newH - 30;
    }

    // Ki·ªÉm tra tr·∫°ng th√°i hi·ªÉn th·ªã: l·∫•y t·ª´ c·ªëc cu·ªëi c√πng ho·∫∑c t·ª´ b√¨nh
    const inheritShowUnit = cups.length > 0 ? lastCup.showUnit : bottle.showUnit;

    const newCup = {
        x: newX,
        y: newY,
        w: newW,
        h: newH,
        capacity: newCapacity,
        fill: 0,
        dragging: false,
        offsetX: 0,
        offsetY: 0,
        showUnit: inheritShowUnit, // K·∫ø th·ª´a tr·∫°ng th√°i t·ª´ c·ªëc cu·ªëi c√πng
        showScale: type === 'measuring',
        type: type
    };

            cups.push(newCup);
            updateSettingsPanel();
            updateAddCupButton();
        }

        function removeCup(index) {
            if (cups.length > 1) {
                cups.splice(index, 1);
                updateSettingsPanel();
                updateAddCupButton();
            } else {
                alert("‚ö†Ô∏è Ph·∫£i c√≥ √≠t nh·∫•t 1 c·ªëc!");
            }
        }

        function updateAddCupButton() {
            const btn = document.getElementById("btnAddCup");
            const btnMeasuring = document.getElementById("btnAddMeasuringCup");
            const totalCups = cups.length;
            btn.textContent = `+ C·ªëc th∆∞·ªùng (${totalCups}/5)`;
            btnMeasuring.textContent = `üìè C·ªëc ƒëo 1L (${totalCups}/5)`;

            if (totalCups >= 5) {
                btn.disabled = true;
                btnMeasuring.disabled = true;
            } else {
                btn.disabled = false;
                btnMeasuring.disabled = false;
            }
        }

        function updateSettingsPanel() {
            const normalContainer = document.getElementById("cupsSettingsContainer");
            const measuringContainer = document.getElementById("measuringCupsSettingsContainer");
            normalContainer.innerHTML = "";
            measuringContainer.innerHTML = "";

            const normalCups = cups.filter(c => c.type === 'normal');
            const measuringCups = cups.filter(c => c.type === 'measuring');

            // C·ªëc th∆∞·ªùng
            if (normalCups.length === 0) {
                normalContainer.innerHTML =
                    '<p style="color: #718096; font-size: 13px; padding: 8px;">Ch∆∞a c√≥ c·ªëc th∆∞·ªùng n√†o</p>';
            } else {
                normalCups.forEach((cup, localIndex) => {
                    const globalIndex = cups.indexOf(cup);
                    normalContainer.appendChild(createCupSettingItem(cup, globalIndex, localIndex + 1));
                });
            }

            // C·ªëc ƒëo
            if (measuringCups.length === 0) {
                measuringContainer.innerHTML =
                    '<p style="color: #718096; font-size: 13px; padding: 8px;">Ch∆∞a c√≥ c·ªëc ƒëo n√†o</p>';
            } else {
                measuringCups.forEach((cup, localIndex) => {
                    const globalIndex = cups.indexOf(cup);
                    measuringContainer.appendChild(createCupSettingItem(cup, globalIndex, localIndex + 1));
                });
            }

            // C·∫≠p nh·∫≠t text c·ªßa n√∫t toggle
            updateToggleButtonText();
        }

        function updateToggleButtonText() {
            const btn = document.getElementById("toggleAllUnits");
            const allHidden = bottle.showUnit === false && cups.every(c => c.showUnit === false);
            btn.textContent = allHidden ? "üëÅÔ∏è‚Äçüó®Ô∏è Hi·ªán t·∫•t c·∫£ ƒë∆°n v·ªã ƒëo" : "üëÅÔ∏è ·∫®n t·∫•t c·∫£ ƒë∆°n v·ªã ƒëo";
        }

        function createCupSettingItem(cup, globalIndex, displayIndex) {
            const div = document.createElement("div");
            div.className = "cup-item";

            const header = document.createElement("div");
            header.className = "cup-header";
            header.style.cursor = "pointer";

            const cupName = document.createElement("span");
            const cupTypeText = cup.type === 'measuring' ? 'C·ªëc ƒëo' : 'C·ªëc';
            cupName.textContent = `${cupTypeText} ${displayIndex}`;

            const cupInfo = document.createElement("span");
            cupInfo.style.fontSize = "13px";
            cupInfo.style.color = "#718096";
            const displayFill = unit === "l" ? (cup.fill / 1000).toFixed(1) : Math.round(cup.fill);
            const displayCapacity = unit === "l" ? (cup.capacity / 1000).toFixed(1) : cup.capacity;
            cupInfo.textContent = `${displayFill}${unit} / ${displayCapacity}${unit}`;

            header.appendChild(cupName);
            header.appendChild(cupInfo);

            const details = document.createElement("div");
            details.className = "cup-details";

            const fillLabel = document.createElement("label");
            fillLabel.textContent = "M·ª©c n∆∞·ªõc hi·ªán t·∫°i:";

            const fillInput = document.createElement("input");
            fillInput.type = "number";
            fillInput.id = `cup${globalIndex}FillInput`;
            fillInput.value = unit === "l" ? (cup.fill / 1000).toFixed(2) : Math.round(cup.fill);
            fillInput.min = "0";
            fillInput.max = unit === "l" ? (cup.capacity / 1000).toFixed(2) : cup.capacity;
            fillInput.step = unit === "l" ? "0.01" : "1";
            fillInput.addEventListener('input', () => settingsChanged = true);

            details.appendChild(fillLabel);
            details.appendChild(fillInput);

            // Dung t√≠ch - ch·ªâ cho ph√©p ch·ªânh s·ª≠a n·∫øu kh√¥ng ph·∫£i c·ªëc ƒëo 1L
            if (cup.type !== 'measuring') {
                const capacityLabel = document.createElement("label");
                capacityLabel.textContent = "Dung t√≠ch t·ªëi ƒëa:";
                capacityLabel.style.marginTop = "8px";

                const capacityInput = document.createElement("input");
                capacityInput.type = "number";
                capacityInput.id = `cup${globalIndex}CapacityInput`;
                capacityInput.value = unit === "l" ? (cup.capacity / 1000).toFixed(2) : cup.capacity;
                capacityInput.min = "1";
                capacityInput.step = unit === "l" ? "0.01" : "1";
                capacityInput.addEventListener('input', () => settingsChanged = true);

                details.appendChild(capacityLabel);
                details.appendChild(capacityInput);
            } else {
                const capacityNote = document.createElement("p");
                capacityNote.style.fontSize = "12px";
                capacityNote.style.color = "#718096";
                capacityNote.style.marginTop = "8px";
                capacityNote.style.fontStyle = "italic";
                capacityNote.textContent = "Dung t√≠ch c·ªë ƒë·ªãnh: 1000ml (1L)";
                details.appendChild(capacityNote);
            }

            // Checkbox hi·ªÉn th·ªã ƒë∆°n v·ªã
            const showUnitLabel = document.createElement("label");
            showUnitLabel.className = "checkbox-label";
            const showUnitCheckbox = document.createElement("input");
            showUnitCheckbox.type = "checkbox";
            showUnitCheckbox.id = `cup${globalIndex}ShowUnit`;
            showUnitCheckbox.checked = cup.showUnit;
            showUnitCheckbox.addEventListener('change', () => {
                settingsChanged = true;
                cup.showUnit = showUnitCheckbox.checked;
            });
            const showUnitText = document.createElement("span");
            showUnitText.textContent = "Hi·ªÉn th·ªã ƒë∆°n v·ªã ƒëo";
            showUnitLabel.appendChild(showUnitCheckbox);
            showUnitLabel.appendChild(showUnitText);
            details.appendChild(showUnitLabel);

            // Checkbox hi·ªÉn th·ªã v·∫°ch chia (ch·ªâ cho c·ªëc ƒëo)
            if (cup.type === 'measuring') {
                const showScaleLabel = document.createElement("label");
                showScaleLabel.className = "checkbox-label";
                const showScaleCheckbox = document.createElement("input");
                showScaleCheckbox.type = "checkbox";
                showScaleCheckbox.id = `cup${globalIndex}ShowScale`;
                showScaleCheckbox.checked = cup.showScale;
                showScaleCheckbox.addEventListener('change', () => {
                    settingsChanged = true;
                    cup.showScale = showScaleCheckbox.checked;
                });
                const showScaleText = document.createElement("span");
                showScaleText.textContent = "Hi·ªÉn th·ªã v·∫°ch chia";
                showScaleLabel.appendChild(showScaleCheckbox);
                showScaleLabel.appendChild(showScaleText);
                details.appendChild(showScaleLabel);
            }

            if (cups.length > 1) {
                const deleteBtn = document.createElement("button");
                deleteBtn.className = "delete-btn";
                deleteBtn.textContent = "üóë X√≥a c·ªëc";
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeCup(globalIndex);
                    settingsChanged = true;
                };
                details.appendChild(deleteBtn);
            }

            div.appendChild(header);
            div.appendChild(details);

            header.addEventListener("click", () => {
                const wasExpanded = div.classList.contains("expanded");

                document.querySelectorAll(".cup-item").forEach(item => {
                    item.classList.remove("expanded");
                });

                if (!wasExpanded) {
                    div.classList.add("expanded");
                }
            });

            return div;
        }

        // Event Listeners
        document.getElementById("btnAddCup").addEventListener("click", () => addCup('normal'));
        document.getElementById("btnAddMeasuringCup").addEventListener("click", () => addCup('measuring'));

        document.getElementById("resetBtn").addEventListener("click", () => {
            bottle = JSON.parse(JSON.stringify(initialState.bottle));
            cups = JSON.parse(JSON.stringify(initialState.cups));
            unit = initialState.unit;
            if (bottleEmpty.complete) setSizeKeepRatio(bottle, bottleEmpty, 210);
            if (cupEmpty.complete) {
                cups.forEach(c => {
                    if (c.type === 'normal') {
                        setSizeKeepRatio(c, cupEmpty, 130);
                    }
                });
            }
            if (measuredCupEmpty.complete) {
                cups.forEach(c => {
                    if (c.type === 'measuring') {
                        setSizeKeepRatio(c, measuredCupEmpty, 160);
                    }
                });
            }
            updateSettingsPanel();
            updateAddCupButton();
            settingsChanged = false;
        });

        document.getElementById("settingsBtn").addEventListener("click", () => {
            const panel = document.getElementById("settingsPanel");
            const isOpen = panel.style.display !== "none";

            if (isOpen) {
                // ƒêang m·ªü, mu·ªën ƒë√≥ng
                if (settingsChanged) {
                    // C√≥ thay ƒë·ªïi ch∆∞a l∆∞u
                    document.getElementById("confirmModal").classList.add("active");
                } else {
                    // Kh√¥ng c√≥ thay ƒë·ªïi, ƒë√≥ng b√¨nh th∆∞·ªùng
                    panel.style.display = "none";
                }
            } else {
                // ƒêang ƒë√≥ng, mu·ªën m·ªü
                savedState = {
                    bottle: JSON.parse(JSON.stringify(bottle)),
                    cups: JSON.parse(JSON.stringify(cups)),
                    unit: unit
                };
                settingsChanged = false;
                panel.style.display = "block";

                document.getElementById("unitSelect").value = unit;
                document.getElementById("bottleFillInput").value = unit === "l" ? (bottle.fill / 1000).toFixed(
                    2) : Math.round(bottle.fill);
                document.getElementById("bottleFillInput").step = unit === "l" ? "0.01" : "1";
                document.getElementById("bottleCapacityInput").value = unit === "l" ? (bottle.capacity / 1000)
                    .toFixed(2) : bottle.capacity;
                document.getElementById("bottleCapacityInput").step = unit === "l" ? "0.01" : "1";
                document.getElementById("bottleShowUnit").checked = bottle.showUnit;
                updateSettingsPanel();
            }
        });

        // Modal confirm buttons
        document.getElementById("modalConfirm").addEventListener("click", () => {
            // H·ªßy thay ƒë·ªïi - kh√¥i ph·ª•c state c≈©
            bottle = JSON.parse(JSON.stringify(savedState.bottle));
            cups = JSON.parse(JSON.stringify(savedState.cups));
            unit = savedState.unit;
            document.getElementById("confirmModal").classList.remove("active");
            document.getElementById("settingsPanel").style.display = "none";
            settingsChanged = false;
        });

        document.getElementById("modalCancel").addEventListener("click", () => {
            // Quay l·∫°i panel ƒë·ªÉ l∆∞u
            document.getElementById("confirmModal").classList.remove("active");
        });

        document.getElementById("toggleAllUnits").addEventListener("click", () => {
            const btn = document.getElementById("toggleAllUnits");
            const allHidden = bottle.showUnit === false && cups.every(c => c.showUnit === false);

            if (allHidden) {
                // Hi·ªán t·∫•t c·∫£
                bottle.showUnit = true;
                cups.forEach(c => c.showUnit = true);
                document.getElementById("bottleShowUnit").checked = true;
                cups.forEach((c, i) => {
                    const checkbox = document.getElementById(`cup${i}ShowUnit`);
                    if (checkbox) checkbox.checked = true;
                });
                btn.textContent = "üëÅÔ∏è ·∫®n t·∫•t c·∫£ ƒë∆°n v·ªã ƒëo";
            } else {
                // ·∫®n t·∫•t c·∫£
                bottle.showUnit = false;
                cups.forEach(c => c.showUnit = false);
                document.getElementById("bottleShowUnit").checked = false;
                cups.forEach((c, i) => {
                    const checkbox = document.getElementById(`cup${i}ShowUnit`);
                    if (checkbox) checkbox.checked = false;
                });
                btn.textContent = "üëÅÔ∏è‚Äçüó®Ô∏è Hi·ªán t·∫•t c·∫£ ƒë∆°n v·ªã ƒëo";
            }
            settingsChanged = true;
            updateToggleButtonText(); // C·∫≠p nh·∫≠t text sau khi thay ƒë·ªïi
        });

        function applySettings() {
            const bottleFillValue = parseFloat(document.getElementById("bottleFillInput").value);
            const bottleCapacityValue = parseFloat(document.getElementById("bottleCapacityInput").value);
            bottle.showUnit = document.getElementById("bottleShowUnit").checked;

            if (!isNaN(bottleCapacityValue) && bottleCapacityValue > 0) {
                bottle.capacity = unit === "l" ? bottleCapacityValue * 1000 : bottleCapacityValue;
            }
            if (!isNaN(bottleFillValue)) {
                bottle.fill = Math.max(0, Math.min(bottle.capacity, unit === "l" ? bottleFillValue * 1000 :
                    bottleFillValue));
            }

            cups.forEach((c, i) => {
                const fillInput = document.getElementById(`cup${i}FillInput`);
                const capacityInput = document.getElementById(`cup${i}CapacityInput`);
                const showUnitCheckbox = document.getElementById(`cup${i}ShowUnit`);
                const showScaleCheckbox = document.getElementById(`cup${i}ShowScale`);

                // C·ªëc ƒëo 1L kh√¥ng cho ph√©p thay ƒë·ªïi dung t√≠ch
                if (capacityInput && c.type !== 'measuring') {
                    const capacityVal = parseFloat(capacityInput.value);
                    if (!isNaN(capacityVal) && capacityVal > 0) {
                        c.capacity = unit === "l" ? capacityVal * 1000 : capacityVal;
                    }
                }

                if (fillInput) {
                    const fillVal = parseFloat(fillInput.value);
                    if (!isNaN(fillVal)) {
                        c.fill = Math.max(0, Math.min(c.capacity, unit === "l" ? fillVal * 1000 : fillVal));
                    }
                }
                if (showUnitCheckbox) {
                    c.showUnit = showUnitCheckbox.checked;
                }
                if (showScaleCheckbox) {
                    c.showScale = showScaleCheckbox.checked;
                }
            });

            settingsChanged = false;
            updateSettingsPanel();
        }

        document.getElementById("unitSelect").addEventListener("change", (e) => {
            unit = e.target.value;
            document.getElementById("bottleFillInput").value = unit === "l" ? (bottle.fill / 1000).toFixed(2) :
                Math.round(bottle.fill);
            document.getElementById("bottleFillInput").step = unit === "l" ? "0.01" : "1";
            document.getElementById("bottleCapacityInput").value = unit === "l" ? (bottle.capacity / 1000)
                .toFixed(2) : bottle.capacity;
            document.getElementById("bottleCapacityInput").step = unit === "l" ? "0.01" : "1";
            updateSettingsPanel();
            settingsChanged = true;
        });

        document.getElementById("applySettings").addEventListener("click", () => {
            applySettings();
            document.getElementById("settingsPanel").style.display = "none";
        });

        // C√°c input trong ph·∫ßn b√¨nh n∆∞·ªõc
        document.getElementById("bottleFillInput").addEventListener('input', () => settingsChanged = true);
        document.getElementById("bottleCapacityInput").addEventListener('input', () => settingsChanged = true);
        document.getElementById("bottleShowUnit").addEventListener('change', () => {
            settingsChanged = true;
            bottle.showUnit = document.getElementById("bottleShowUnit").checked;
        });

        document.getElementById("settingsPanel").addEventListener("keydown", (e) => {
            if (e.key === "Enter" && e.target.tagName === "INPUT") {
                e.preventDefault();
                applySettings();
            }
        });

        canvas.addEventListener("mousedown", e => {
            const mx = e.offsetX,
                my = e.offsetY;
            if (mx > bottle.x && mx < bottle.x + bottle.w && my > bottle.y && my < bottle.y + bottle.h) {
                bottle.dragging = true;
                bottle.offsetX = mx - bottle.x;
                bottle.offsetY = my - bottle.y;
                return;
            }
            for (let i = cups.length - 1; i >= 0; i--) {
                const c = cups[i];
                if (mx > c.x && mx < c.x + c.w && my > c.y && my < c.y + c.h) {
                    c.dragging = true;
                    c.offsetX = mx - c.x;
                    c.offsetY = my - c.y;
                    break;
                }
            }
        });

        canvas.addEventListener("mousemove", e => {
            const mx = e.offsetX,
                my = e.offsetY;
            if (bottle.dragging) {
                bottle.x = mx - bottle.offsetX;
                bottle.y = my - bottle.offsetY;
            }
            cups.forEach(c => {
                if (c.dragging) {
                    c.x = mx - c.offsetX;
                    c.y = my - c.offsetY;
                }
            });
        });

        canvas.addEventListener("mouseup", () => {
            bottle.dragging = false;
            cups.forEach(c => c.dragging = false);
        });
    </script>
</body>

</html>