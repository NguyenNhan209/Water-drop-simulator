<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <title>K√©o th·∫£ b√¨nh ƒë·ªÉ r√≥t v√†o c·ªëc</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 16px 24px;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #1a202c;
            margin: 0;
        }

        #controls {
            display: flex;
            gap: 12px;
        }

        button {
            padding: 10px 20px;
            border: none;
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
            color: #fff;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 2s ease;
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            cursor: not-allowed !important;
            opacity: 0.5 !important;
            transform: none !important;
        }

        #resetBtn {
            /* ƒê·ªè nh·∫π - reset */
            background: linear-gradient(135deg, #E85D75 0%, #D14D65 100%);
            box-shadow: 0 2px 8px rgba(232, 93, 117, 0.3);
        }

        #resetBtn:hover {
            box-shadow: 0 4px 12px rgba(232, 93, 117, 0.4);
        }

        #btnAddCup {
            /* Xanh l√° nh·∫π - th√™m c·ªëc */
            background: linear-gradient(135deg, #52C997 0%, #42B883 100%);
            box-shadow: 0 2px 8px rgba(82, 201, 151, 0.3);
        }

        #btnAddCup:hover {
            box-shadow: 0 4px 12px rgba(82, 201, 151, 0.4);
        }

        #btnAddMeasuringCup {
            /* Cam gi√°o d·ª•c - c·ªëc ƒëo */
            background: linear-gradient(135deg, #FF9A56 0%, #FF7E3D 100%);
            box-shadow: 0 2px 8px rgba(255, 154, 86, 0.3);
        }

        #btnAddMeasuringCup:hover {
            box-shadow: 0 4px 12px rgba(255, 154, 86, 0.4);
        }

        #settingsBtn {
            background: linear-gradient(135deg, #5B7C99 0%, #4A6B85 100%);
            box-shadow: 0 2px 8px rgba(91, 124, 153, 0.3);
        }

        #settingsBtn:hover {
            box-shadow: 0 4px 12px rgba(91, 124, 153, 0.4);
        }

        .canvas-wrapper {
            position: relative;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        canvas {
            width: 100%;
            height: 70vh;
            border-radius: 12px;
            display: block;
            /* N·ªÅn tr·∫Øng s·∫°ch - d·ªÖ quan s√°t */
            background: #FFFFFF;
            cursor: grab;
        }

        canvas:active {
            cursor: grabbing;
        }

        #settingsPanel {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%) translateX(100%);
            /* ‚Üê Th√™m translateX ƒë·ªÉ ·∫©n b√™n ph·∫£i */
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            height: 80vh;
            min-width: 320px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            opacity: 0;
            /* ‚Üê B·∫Øt ƒë·∫ßu trong su·ªët */
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            /* ‚Üê Animation m∆∞·ª£t */
            pointer-events: none;
            /* ‚Üê Kh√¥ng t∆∞∆°ng t√°c khi ·∫©n */
        }

        #settingsPanel.active {
            transform: translateY(-50%) translateX(0);
            /* ‚Üê Tr∆∞·ª£t v√†o */
            opacity: 1;
            /* ‚Üê Hi·ªán r√µ */
            pointer-events: all;
            /* ‚Üê Cho ph√©p t∆∞∆°ng t√°c */
        }

        #settingsOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            /* ‚Üê ƒê·ªïi t·ª´ 0.3 th√†nh 0.5 (ƒëen h∆°n) */
            z-index: 999;
            backdrop-filter: blur(2px);
            opacity: 0;
            /* ‚Üê B·∫Øt ƒë·∫ßu trong su·ªët */
            transition: opacity 0.3s ease;
            /* ‚Üê Animation fade */
        }

        #settingsOverlay.active {
            display: block;
            opacity: 1;
            /* ‚Üê Fade in */
        }

        /* ‚Üê Th√™m m·ªõi: Header c·ªë ƒë·ªãnh */
        #settingsHeader {
            padding: 24px 24px 16px 24px;
            background: rgba(255, 255, 255, 0.98);
            border-bottom: 1px solid #e2e8f0;
            flex-shrink: 0;
        }

        /* ‚Üê Th√™m m·ªõi: Content cu·ªôn ƒë∆∞·ª£c */
        #settingsContent {
            padding: 16px 24px 24px 24px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
            max-height: calc(80vh - 80px);
            /* ‚Üê Th√™m d√≤ng n√†y, 80px l√† chi·ªÅu cao header */
        }

        /* ‚Üê Th√™m m·ªõi: T√πy ch·ªânh scrollbar */
        #settingsContent::-webkit-scrollbar {
            width: 8px;
        }

        #settingsContent::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        #settingsContent::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }

        #settingsContent::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        #settingsPanel h4 {
            margin: 0 0 16px 0;
            color: #1a202c;
            font-size: 18px;
            font-weight: 600;
        }

        #settingsPanel label {
            display: block;
            margin-top: 12px;
            color: #4a5568;
            font-size: 14px;
            font-weight: 500;
        }

        #settingsPanel input,
        #settingsPanel select {
            width: 100%;
            padding: 8px 12px;
            margin-top: 6px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        #settingsPanel input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        #settingsPanel input:focus,
        #settingsPanel select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        #settingsPanel select {
            cursor: pointer;
        }

        #settingsPanel hr {
            margin: 16px 0;
            border: none;
            border-top: 1px solid #e2e8f0;
        }

        #cupsSettingsContainer,
        #measuringCupsSettingsContainer {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .cup-item {
            padding: 12px;
            background: #f7fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cup-item:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .cup-item.expanded {
            background: #fff;
            border-color: #4A90E2;
            cursor: default;
        }

        .cup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            color: #1a202c;
            font-size: 14px;
            padding: 4px 0;
        }

        .cup-details {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
        }

        .cup-item.expanded .cup-details {
            display: block;
        }

        .cup-item.expanded .cup-header {
            font-weight: 600;
            color: #4A90E2;
        }

        #cupsSettingsContainer label,
        #measuringCupsSettingsContainer label {
            margin: 0 0 4px 0;
            font-size: 12px;
            color: #718096;
        }

        .delete-btn {
            margin-top: 8px;
            width: 100%;
            padding: 8px;
            font-size: 13px;
            background: linear-gradient(135deg, #E85D75 0%, #D14D65 100%);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            margin-top: 8px;
            cursor: pointer;
            font-size: 13px;
        }

        .settings-section {
            padding: 12px;
            background: #f7fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            margin-top: 8px;
        }

        .hide-all-btn {
            width: 100%;
            margin-top: 8px;
            background: linear-gradient(135deg, #5ED5A8 0%, #42B883 100%);
            color: white;
            box-shadow: 0 2px 6px rgba(66, 184, 131, 0.25);
            transition: all 0.3s ease;
        }

        .hide-all-btn.hidden-state {
            background: linear-gradient(135deg, #FF9A56 0%, #FF7E3D 100%);
            box-shadow: 0 2px 6px rgba(255, 154, 86, 0.25);
        }

        .hide-all-btn.hidden-state:hover {
            box-shadow: 0 4px 10px rgba(255, 154, 86, 0.35);
        }

        .hide-all-btn.ml-state {
            background: linear-gradient(135deg, #9F7AEA 0%, #805AD5 100%);
            box-shadow: 0 2px 6px rgba(159, 122, 234, 0.25);
        }

        .hide-all-btn.ml-state:hover {
            box-shadow: 0 4px 10px rgba(159, 122, 234, 0.35);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 16px;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .modal-content h3 {
            margin: 0 0 12px 0;
            color: #1a202c;
            font-size: 18px;
        }

        .modal-content p {
            margin: 0 0 20px 0;
            color: #4a5568;
            line-height: 1.5;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-buttons button {
            padding: 8px 16px;
            font-size: 14px;
        }

        #settingsOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 999;
            backdrop-filter: blur(2px);
        }

        #settingsOverlay.active {
            display: block;
        }

        /* ========== TOAST BANNER ========== */
        .toast-banner {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-120%);
            background: linear-gradient(135deg, #FFE89C 0%, #FFD966 100%);
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 16px 24px;
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3);
            z-index: 2000;
            max-width: 90%;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toast-banner.show {
            transform: translateX(-50%) translateY(0);
        }

        .toast-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-text {
            flex: 1;
            min-width: 250px;
            color: #6B4423;
            font-weight: 500;
            font-size: 15px;
        }

        .toast-btn-help {
            padding: 8px 16px;
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .toast-btn-help:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
        }

        .toast-btn-dismiss {
            padding: 8px 16px;
            background: linear-gradient(135deg, #52C997 0%, #42B883 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .toast-btn-dismiss:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(82, 201, 151, 0.4);
        }

        .toast-btn-close {
            width: 28px;
            height: 28px;
            padding: 0;
            background: rgba(107, 68, 35, 0.1);
            color: #6B4423;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .toast-btn-close:hover {
            background: rgba(107, 68, 35, 0.2);
        }

        /* ========== HELP PANEL MODAL ========== */
        .help-panel {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: helpSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes helpSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .help-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 28px;
            border-bottom: 2px solid #e2e8f0;
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);

            border-radius: 20px 20px 0 0;
        }

        .help-header h3 {
            margin: 0;
            color: white;
            font-size: 22px;
            font-weight: 600;
        }

        .close-help-btn {
            width: 36px;
            height: 36px;
            padding: 0;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 28px;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-help-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .help-content {
            padding: 24px 28px;
            overflow-y: auto;
            flex: 1;
        }

        .help-content::-webkit-scrollbar {
            width: 8px;
        }

        .help-content::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        .help-content::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }

        .help-content::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        .help-section {
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid #e2e8f0;
        }

        .help-section:last-of-type {
            border-bottom: none;
            margin-bottom: 16px;
        }

        .help-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .help-section h4 {
            margin: 0 0 16px 0;
            color: #1e293b;
            font-size: 18px;
            font-weight: 600;
        }

        .help-image-placeholder {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .help-section ul {
            margin: 12px 0 0 0;
            padding-left: 24px;
        }

        .help-section li {
            margin: 10px 0;
            color: #475569;
            line-height: 1.6;
            font-size: 15px;
        }

        .help-section li strong {
            color: #1e293b;
            font-weight: 600;
        }

        .help-footer {
            background: linear-gradient(135deg, #FFE89C 0%, #FFD966 100%);
            border: 2px solid #fbbf24;
            border-radius: 12px;
            padding: 16px;
            margin-top: 8px;
        }

        .help-footer p {
            margin: 0;
            color: #6B4423;
            font-size: 14px;
            line-height: 1.6;
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            .toast-content {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }

            .toast-text {
                min-width: 0;
            }

            .toast-btn-help,
            .toast-btn-dismiss {
                width: 100%;
            }

            .help-panel {
                width: 95%;
                max-height: 90vh;
            }

            .help-header {
                padding: 20px;
            }

            .help-content {
                padding: 20px;
            }

            .help-section li {
                font-size: 14px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üåä M√¥ ph·ªèng r√≥t n∆∞·ªõc</h1>
            <div id="controls">
                <button id="resetBtn">‚Ü∫ Reset</button>
                <button id="btnAddCup">+ C·ªëc th∆∞·ªùng</button>
                <button id="btnAddMeasuringCup">üìè C·ªëc ƒëo 1L</button>
                <button id="helpBtn">üìñ H∆∞·ªõng d·∫´n</button>
                <button id="settingsBtn">‚öô C√†i ƒë·∫∑t</button>
            </div>
        </div>

        <div class="canvas-wrapper">
            <canvas id="world"></canvas>
        </div>
        <div id="settingsOverlay"></div>
    </div>

    <!-- Toast Banner -->
    <div id="toastBanner" class="toast-banner">
        <div class="toast-content">
            <span class="toast-icon">üí°</span>
            <span class="toast-text">M·∫πo: K√©o b√¨nh sang b√™n ph·∫£i c·ªëc v√† ƒë·∫∑t cao h∆°n ƒë·ªÉ r√≥t n∆∞·ªõc!</span>
            <button id="toastHelpBtn" class="toast-btn-help">üìñ Xem h∆∞·ªõng d·∫´n</button>
            <button id="toastDismissBtn" class="toast-btn-dismiss">‚úì ƒê√£ hi·ªÉu</button>
            <button id="toastCloseBtn" class="toast-btn-close">√ó</button>
        </div>
    </div>

    <!-- Settings Overlay -->
    <div id="settingsOverlay"></div>

    <!-- Settings Panel -->
    <div id="settingsPanel">
        <div id="settingsHeader">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h4 style="margin: 0;">‚öôÔ∏è C√†i ƒë·∫∑t</h4>
                <button id="applySettings">‚úì √Åp d·ª•ng</button>
            </div>
        </div>

        <div id="settingsContent">
            <label>
                ƒê∆°n v·ªã ƒëo b√¨nh n∆∞·ªõc
                <select id="bottleUnitSelect">
                    <option value="ml">Mililit (ml)</option>
                    <option value="l">L√≠t (l)</option>
                </select>
            </label>

            <button class="hide-all-btn" id="toggleAllUnits">üëÅÔ∏è ·∫®n t·∫•t c·∫£ ƒë∆°n v·ªã ƒëo</button>

            <hr>

            <label style="font-size: 14px; font-weight: 600; color: #1a202c; margin-bottom: 8px;">
                üç∂ B√¨nh n∆∞·ªõc
            </label>
            <div class="settings-section">
                <label style="font-size: 12px; color: #718096;">
                    M·ª©c n∆∞·ªõc hi·ªán t·∫°i
                    <input type="number" id="bottleFillInput" />
                </label>
                <label style="font-size: 12px; color: #718096;">
                    Dung t√≠ch t·ªëi ƒëa
                    <input type="number" id="bottleCapacityInput" />
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="bottleShowUnit" checked />
                    <span>Hi·ªÉn th·ªã ƒë∆°n v·ªã ƒëo</span>
                </label>
            </div>

            <hr>

            <label style="font-size: 14px; font-weight: 600; color: #1a202c; margin-bottom: 8px;">
                ü•§ C·ªëc th∆∞·ªùng
            </label>
            <div id="cupsSettingsContainer" style="margin-top: 8px;"></div>

            <hr>

            <label style="font-size: 14px; font-weight: 600; color: #1a202c; margin-bottom: 8px;">
                üìè C·ªëc ƒëo 1 l√≠t
            </label>
            <div id="measuringCupsSettingsContainer" style="margin-top: 8px;"></div>

            <hr>
        </div>
    </div>

    <!-- Help Panel Modal -->
    <div id="helpModal" class="modal-overlay">
        <div class="help-panel">
            <div class="help-header">
                <h3>üìñ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h3>
                <button id="closeHelpBtn" class="close-help-btn">√ó</button>
            </div>
            <div class="help-content">
                <section class="help-section">
                    <div class="help-icon">üåä</div>
                    <h4>1. C√°ch r√≥t n∆∞·ªõc</h4>
                    <div class="help-image-placeholder">
                        <svg width="100%" height="120" viewBox="0 0 200 120">
                            <rect x="140" y="20" width="40" height="60" fill="#e0f2fe" stroke="#0284c7" stroke-width="2"
                                rx="5" />
                            <text x="160" y="95" text-anchor="middle" font-size="10" fill="#64748b">C·ªëc</text>
                            <rect x="110" y="10" width="25" height="50" fill="#bae6fd" stroke="#0284c7" stroke-width="2"
                                rx="3" />
                            <text x="122" y="70" text-anchor="middle" font-size="10" fill="#64748b">B√¨nh</text>
                            <path d="M 135 35 L 145 35" stroke="#ef4444" stroke-width="2" marker-end="url(#arrowred)" />
                            <defs>
                                <marker id="arrowred" markerWidth="10" markerHeight="10" refX="5" refY="3"
                                    orient="auto">
                                    <polygon points="0 0, 6 3, 0 6" fill="#ef4444" />
                                </marker>
                            </defs>
                        </svg>
                    </div>
                    <ul>
                        <li>K√©o b√¨nh n∆∞·ªõc sang <strong>b√™n ph·∫£i</strong> c·ªëc</li>
                        <li>ƒê·∫∑t b√¨nh <strong>cao h∆°n</strong> c·ªëc (g√≥c tr√°i tr√™n b√¨nh ph·∫£i cao h∆°n c·∫°nh tr√™n c·ªëc m·ªôt
                            kho·∫£ng)</li>
                        <li>B√¨nh s·∫Ω t·ª± ƒë·ªông <strong>nghi√™ng</strong> v√† r√≥t n∆∞·ªõc</li>
                        <li><strong>Click v√†o b√¨nh</strong> ƒë·ªÉ k√≠ch ho·∫°t ch·∫ø ƒë·ªô r√≥t (v·ªõi c·ªëc m·ªõi t·∫°o)</li>
                    </ul>
                </section>

                <section class="help-section">
                    <div class="help-icon">ü•§</div>
                    <h4>2. Th√™m/X√≥a c·ªëc</h4>
                    <div class="help-image-placeholder">
                        <svg width="100%" height="80" viewBox="0 0 200 80">
                            <rect x="30" y="20" width="35" height="50" fill="#e0f2fe" stroke="#0284c7" stroke-width="2"
                                rx="5" />
                            <rect x="80" y="20" width="35" height="50" fill="#e0f2fe" stroke="#0284c7" stroke-width="2"
                                rx="5" />
                            <rect x="130" y="20" width="35" height="50" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"
                                rx="5" />
                            <line x1="135" y1="30" x2="160" y2="30" stroke="#78716c" stroke-width="1" />
                            <line x1="135" y1="45" x2="160" y2="45" stroke="#78716c" stroke-width="1" />
                            <line x1="135" y1="60" x2="160" y2="60" stroke="#78716c" stroke-width="1" />
                            <text x="47.5" y="78" text-anchor="middle" font-size="9" fill="#64748b">C·ªëc th∆∞·ªùng</text>
                            <text x="147.5" y="78" text-anchor="middle" font-size="9" fill="#64748b">C·ªëc ƒëo</text>
                        </svg>
                    </div>
                    <ul>
                        <li>Nh·∫•n <strong>"+ C·ªëc th∆∞·ªùng"</strong> ƒë·ªÉ th√™m c·ªëc b√¨nh th∆∞·ªùng</li>
                        <li>Nh·∫•n <strong>"üìè C·ªëc ƒëo 1L"</strong> ƒë·ªÉ th√™m c·ªëc c√≥ v·∫°ch chia</li>
                        <li>T·ªëi ƒëa <strong>5 c·ªëc</strong> c√πng l√∫c</li>
                        <li>X√≥a c·ªëc trong <strong>‚öô C√†i ƒë·∫∑t ‚Üí ch·ªçn c·ªëc ‚Üí üóë X√≥a</strong></li>
                    </ul>
                </section>

                <section class="help-section">
                    <div class="help-icon">‚öôÔ∏è</div>
                    <h4>3. C√†i ƒë·∫∑t</h4>
                    <ul>
                        <li>ƒêi·ªÅu ch·ªânh <strong>dung t√≠ch</strong> v√† <strong>m·ª©c n∆∞·ªõc</strong> c·ªßa b√¨nh/c·ªëc</li>
                        <li>Chuy·ªÉn ƒë·ªïi <strong>ƒë∆°n v·ªã</strong> gi·ªØa ml v√† l√≠t</li>
                        <li>·∫®n/hi·ªán <strong>th√¥ng tin ƒë∆°n v·ªã ƒëo</strong> tr√™n m√†n h√¨nh</li>
                        <li>B·∫≠t/t·∫Øt <strong>v·∫°ch chia</strong> tr√™n c·ªëc ƒëo 1L</li>
                    </ul>
                </section>

                <section class="help-section">
                    <div class="help-icon">üéÆ</div>
                    <h4>4. Thao t√°c kh√°c</h4>
                    <ul>
                        <li><strong>K√©o th·∫£</strong> b√¨nh v√† c·ªëc ƒë·ªÉ di chuy·ªÉn v·ªã tr√≠</li>
                        <li>Nh·∫•n <strong>"‚Ü∫ Reset"</strong> ƒë·ªÉ kh·ªüi ƒë·ªông l·∫°i tr√≤ ch∆°i</li>
                        <li>Nh·∫•n <strong>"‚úì √Åp d·ª•ng"</strong> trong C√†i ƒë·∫∑t ƒë·ªÉ l∆∞u thay ƒë·ªïi</li>
                        <li>C·ªëc m·ªõi t·∫°o c·∫ßn <strong>click v√†o b√¨nh</strong> tr∆∞·ªõc khi r√≥t</li>
                    </ul>
                </section>

                <div class="help-footer">
                    <p>üí° <strong>M·∫πo:</strong> Th·ª≠ nghi·ªám v·ªõi c√°c v·ªã tr√≠ kh√°c nhau ƒë·ªÉ hi·ªÉu r√µ c√°ch r√≥t n∆∞·ªõc!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <h3>üíæ L∆∞u thay ƒë·ªïi?</h3>
            <p>B·∫°n c√≥ thay ƒë·ªïi ch∆∞a ƒë∆∞·ª£c l∆∞u. B·∫°n mu·ªën l∆∞u c√°c thay ƒë·ªïi n√†y kh√¥ng?</p>
            <div class="modal-buttons">
                <button id="modalCancel" style="background: linear-gradient(135deg, #5B7C99 0%, #4A6B85 100%);">‚Üê Quay
                    l·∫°i</button>
                <button id="modalConfirm" style="background: linear-gradient(135deg, #52C997 0%, #42B883 100%);">‚úì L∆∞u
                    v√† ƒë√≥ng</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById("world");
        const ctx = canvas.getContext("2d");

        // Bi·∫øn to√†n c·ª•c
        let settingsChanged = false;
        let bottle = {
            x: 550,
            y: 80,
            w: 120,
            h: 220,
            capacity: 2000,
            fill: 2000,
            pouring: false,
            angle: 0,
            dragging: false,
            offsetX: 0,
            offsetY: 0,
            showUnit: true,
            unit: 'l'
        };

        let cups = [{
            x: 200,
            y: 150,
            w: 120,
            h: 180,
            capacity: 1000,
            fill: 0,
            dragging: false,
            offsetX: 0,
            offsetY: 0,
            showUnit: true,
            showScale: false,
            type: 'normal',
            unit: 'l',
            justCreated: true
        }];
        // L∆∞u state ban ƒë·∫ßu v√† state t·∫°m th·ªùi
        let savedState = null;
        let tempState = null;

        function saveInitialState() {
            return {
                bottle: JSON.parse(JSON.stringify(bottle)),
                cups: JSON.parse(JSON.stringify(cups))
            };
        }
        let initialState = saveInitialState();

        // Images
        const cupEmpty = new Image();
        const cupFull = new Image();
        const bottleEmpty = new Image();
        const bottleFull = new Image();
        const measuredCupEmpty = new Image();
        const measuredCupFull = new Image();
        let loaded = 0;
        let t = 0;

        function onLoad() {
            loaded++;
            if (loaded === 6) {
                animate();
                updateAddCupButton();
            }
        }

        cupEmpty.onload = () => {
            cups.forEach(cup => {
                if (cup.type === 'normal') {
                    setSizeKeepRatio(cup, cupEmpty, 130);
                }
            });
            onLoad();
        };
        cupFull.onload = onLoad;
        bottleEmpty.onload = () => {
            setSizeKeepRatio(bottle, bottleEmpty, 210);
            onLoad();
        };
        bottleFull.onload = onLoad;
        measuredCupEmpty.onload = () => {
            cups.forEach(cup => {
                if (cup.type === 'measuring') {
                    setSizeKeepRatio(cup, measuredCupEmpty, 160);
                }
            });
            onLoad();
        };
        measuredCupFull.onload = onLoad;

        cupEmpty.src = "res/cup_empty.png?v=20251014234757";
        cupFull.src = "res/cup_full.png?v=20251014234757";
        bottleEmpty.src = "res/bottle_empty.png?v=20251014234757";
        bottleFull.src = "res/bottle_full.png?v=20251014234757";
        measuredCupEmpty.src = "res/measured_cup_empty.png?v=20251014234757";
        measuredCupFull.src = "res/measured_cup_full.png?v=20251014234757";

        function resizeCanvas() {
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
            cups.forEach((cup, i) => {
                if (cup.type === 'measuring' && cup.showScale) {
                    cup.x = canvas.width * 0.9 + i * 100;
                    cup.y = canvas.height * 0.4;
                } else {
                    cup.x = canvas.width * 0.2 + i * 150;
                    cup.y = canvas.height * 0.6;
                }
            });
            bottle.x = canvas.width * 0.6;
            bottle.y = canvas.height * 0.2;
        }
        resizeCanvas();
        window.addEventListener("resize", resizeCanvas);

        function setSizeKeepRatio(obj, img, targetHeight) {
            const ratio = img.naturalWidth / img.naturalHeight;
            obj.h = targetHeight;
            obj.w = obj.h * ratio;
        }

        function drawCup(cup, index, highlight = false) {
            if (highlight) {
                ctx.save();
                ctx.fillStyle = "rgba(0,200,255,0.15)";
                ctx.fillRect(cup.x - 10, cup.y - 10, cup.w + 20, cup.h + 20);
                ctx.restore();
            }

            // V·∫Ω c·ªëc r·ªóng (n·ªÅn)
            if (cupEmpty.complete) {
                if (cup.type === 'measuring' && cup.showScale) {
                    // V·∫Ω c·ªëc ƒëo v·ªõi t·ªâ l·ªá g·ªëc (kh√¥ng k√©o d√£n)
                    ctx.drawImage(measuredCupEmpty, cup.x, cup.y, cup.w, cup.h);
                } else {
                    ctx.drawImage(cupEmpty, cup.x, cup.y, cup.w, cup.h);
                }
            } else {
                ctx.strokeStyle = "#2c3e50";
                ctx.strokeRect(cup.x, cup.y, cup.w, cup.h);
            }

            // V·∫Ω n∆∞·ªõc
            if (cup.fill > 0) {
                const percent = cup.fill / cup.capacity;
                const waterHeight = cup.h * percent;

                // X·ª≠ l√Ω ri√™ng cho c·ªëc ƒëo (c·∫Øt ·∫£nh v·ªõi t·ªâ l·ªá ch√≠nh x√°c)
                if (cup.type === 'measuring' && cup.showScale && measuredCupFull.complete) {
                    // Th√¥ng s·ªë ·∫£nh g·ªëc (measured_cup_full.png: 370√ó392px)
                    const imgWidth = measuredCupFull.naturalWidth; // 370px
                    const imgHeight = measuredCupFull.naturalHeight; // 392px

                    // S·ª≠ d·ª•ng s·ªë li·ªáu ƒëo th·ª±c t·∫ø (ƒëo t·ª´ ƒë√°y ·∫£nh l√™n):
                    // V·∫°ch: 0ml=13px, 100ml=33px, 200ml=64px, 300ml=95px, 400ml=126px, 
                    //       500ml=157px, 900ml=281px, 1000ml=313px
                    // 
                    // Ph√¢n t√≠ch: 
                    // - 0‚Üí100ml: 20px (ƒë√°y c·ªëc r·ªông)
                    // - 100‚Üí900ml: ~31px/100ml (ƒë·ªÅu ƒë·∫∑n)
                    // - V√πng ·ªïn ƒë·ªãnh: 100-900ml c√≥ t·ª∑ l·ªá tuy·∫øn t√≠nh

                    const waterBottomY = 392 - 13; // ƒê√°y n∆∞·ªõc = 379px (0ml)
                    const waterTopY = 392 - 313; // ƒê·ªânh n∆∞·ªõc = 79px (1000ml)

                    // T√≠nh v·ªã tr√≠ Y d·ª±a tr√™n ml hi·ªán t·∫°i
                    const currentMl = cup.fill;
                    let sourceY;

                    if (currentMl <= 100) {
                        // V√πng 0-100ml: n·ªôi suy tuy·∫øn t√≠nh
                        const ratio = currentMl / 100;
                        const heightInImage = 20 * ratio; // 0‚Üí100ml = 20px
                        sourceY = waterBottomY - heightInImage;
                    } else {
                        // V√πng 100-1000ml: t·ª∑ l·ªá ƒë·ªÅu 31px/100ml
                        const mlAbove100 = currentMl - 100;
                        const heightAbove100 = (mlAbove100 / 100) * 31; // 31px m·ªói 100ml
                        sourceY = (392 - 33) - heightAbove100; // B·∫Øt ƒë·∫ßu t·ª´ v·∫°ch 100ml (y=359)
                    }

                    // Gi·ªõi h·∫°n v√πng c·∫Øt trong ph·∫°m vi n∆∞·ªõc (kh√¥ng v∆∞·ª£t qu√° ƒë·ªânh n∆∞·ªõc)
                    const clampedSourceY = Math.max(waterTopY, sourceY);
                    const clampedSourceHeight = waterBottomY - clampedSourceY;

                    // T√≠nh scale d·ª±a tr√™n t·ª∑ l·ªá ·∫£nh g·ªëc ƒë·ªÉ ƒë·∫£m b·∫£o ch√≠nh x√°c
                    // T√≠nh scale t·ª´ c·∫£ width v√† height, l·∫•y gi√° tr·ªã nh·ªè h∆°n ƒë·ªÉ gi·ªØ nguy√™n t·ª∑ l·ªá
                    const scaleW = cup.w / imgWidth;
                    const scaleH = cup.h / imgHeight;
                    const scale = Math.min(scaleW, scaleH); // D√πng scale nh·ªè h∆°n ƒë·ªÉ kh√¥ng b·ªã m√©o

                    // T√≠nh l·∫°i k√≠ch th∆∞·ªõc th·ª±c t·∫ø hi·ªÉn th·ªã (gi·ªØ nguy√™n t·ª∑ l·ªá ·∫£nh g·ªëc)
                    const actualWidth = imgWidth * scale;
                    const actualHeight = imgHeight * scale;

                    // CƒÉn gi·ªØa n·∫øu c·ªëc r·ªông h∆°n ·∫£nh sau khi scale
                    const offsetX = (cup.w - actualWidth) / 2;
                    const offsetY = (cup.h - actualHeight) / 2;

                    // T√≠nh v·ªã tr√≠ tr√™n canvas: 
                    const destY = cup.y + offsetY + (clampedSourceY * scale);
                    const destHeight = clampedSourceHeight * scale;
                    const destX = cup.x + offsetX;
                    const destWidth = actualWidth;

                    // V·∫Ω ph·∫ßn n∆∞·ªõc ƒë√£ c·∫Øt
                    ctx.drawImage(
                        measuredCupFull,
                        0, // sourceX: t·ª´ tr√°i ·∫£nh g·ªëc
                        clampedSourceY, // sourceY: v·ªã tr√≠ b·∫Øt ƒë·∫ßu c·∫Øt
                        imgWidth, // sourceWidth: to√†n b·ªô chi·ªÅu r·ªông g·ªëc
                        clampedSourceHeight, // sourceHeight: chi·ªÅu cao c·∫Øt
                        destX, // destX: v·ªã tr√≠ x tr√™n canvas (c√≥ cƒÉn gi·ªØa)
                        destY, // destY: v·ªã tr√≠ y tr√™n canvas
                        destWidth, // destWidth: chi·ªÅu r·ªông th·ª±c t·∫ø (gi·ªØ t·ª∑ l·ªá)
                        destHeight // destHeight: chi·ªÅu cao canvas
                    );
                } else {
                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(cup.x, cup.y + cup.h - waterHeight);

                    // T·∫°o s√≥ng n∆∞·ªõc
                    for (let x = 0; x <= cup.w; x += 5) {
                        const y = Math.sin((x / 50) * Math.PI * 2 + t) * 6;
                        ctx.lineTo(cup.x + x, cup.y + cup.h - waterHeight + y);
                    }

                    ctx.lineTo(cup.x + cup.w, cup.y + cup.h);
                    ctx.lineTo(cup.x, cup.y + cup.h);
                    ctx.closePath();
                    ctx.clip();

                    if (cupFull.complete) {
                        ctx.drawImage(cupFull, cup.x, cup.y, cup.w, cup.h);
                    } else {
                        ctx.fillStyle = "rgba(0,150,255,0.6)";
                        ctx.fillRect(cup.x, cup.y + cup.h - waterHeight, cup.w, waterHeight);
                    }
                    ctx.restore();
                }
            }
            // Hi·ªÉn th·ªã th√¥ng tin
            if (cup.showUnit) {
                ctx.fillStyle = "#1a202c";
                ctx.font = "bold 14px sans-serif";
                const cupUnit = cup.unit || 'l';
                const displayFill = cupUnit === "l" ? (cup.fill / 1000).toFixed(2) : Math.round(cup.fill);
                const displayCapacity = cupUnit === "l" ? (cup.capacity / 1000).toFixed(2) : cup.capacity;
                const cupType = cup.type === 'measuring' ? 'C·ªëc ƒëo' : 'C·ªëc';
                const normalCupIndex = cups.filter((c, i) => c.type === cup.type && cups.indexOf(c) <= cups.indexOf(
                    cup)).length;
                ctx.fillText(`${cupType} ${normalCupIndex}: ${displayFill} / ${displayCapacity} ${cupUnit}`, cup.x, cup
                    .y + cup.h + 20);
            }
        }

        function drawBottle() {
            ctx.save();
            ctx.translate(bottle.x + bottle.w / 2, bottle.y + bottle.h / 2);
            ctx.rotate(bottle.angle);
            ctx.drawImage(bottleEmpty, -bottle.w / 2, -bottle.h / 2, bottle.w, bottle.h);

            if (bottle.fill > 0) {
                const percent = bottle.fill / bottle.capacity;
                const waterHeight = bottle.h * percent;
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(-bottle.w / 2, -bottle.h / 2 + (bottle.h - waterHeight));
                for (let x = 0; x <= bottle.w; x += 5) {
                    const y = Math.sin((x / 40) * Math.PI * 2 + t) * 5;
                    ctx.lineTo(-bottle.w / 2 + x, -bottle.h / 2 + (bottle.h - waterHeight) + y);
                }
                ctx.lineTo(bottle.w / 2, bottle.h / 2);
                ctx.lineTo(-bottle.w / 2, bottle.h / 2);
                ctx.closePath();
                ctx.clip();
                ctx.drawImage(bottleFull, -bottle.w / 2, -bottle.h / 2, bottle.w, bottle.h);
                ctx.restore();
            }
            ctx.restore();

            // V·∫Ω d√≤ng n∆∞·ªõc
            if (bottle.pouring && bottle.fill > 0) {
                const cx = bottle.x + bottle.w / 2;
                const cy = bottle.y + bottle.h / 2;
                const cos = Math.cos(bottle.angle);
                const sin = Math.sin(bottle.angle);
                const mouthX = cx - bottle.w / 2 * cos + bottle.h / 2 * sin;
                const mouthY = cy - bottle.w / 2 * sin - bottle.h / 2 * cos;

                let targetCup = null;
                let minDist = Infinity;
                cups.forEach(cup => {
                    const bottleCenterX = bottle.x + bottle.w / 2;
                    const cupCenterX = cup.x + cup.w / 2;
                    const isBottleOnRight = bottleCenterX > cupCenterX;

                    if (isNearCup(bottle, cup) && cup.fill < cup.capacity && isBottleOnRight) {
                        const dist = Math.hypot((bottle.x + bottle.w / 2) - (cup.x + cup.w / 2), (bottle.y +
                            bottle.h / 2) - (cup.y + cup.h / 2));
                        if (dist < minDist) {
                            minDist = dist;
                            targetCup = cup;
                        }
                    }
                });

                if (targetCup) {
                    const targetX = targetCup.x + targetCup.w / 2;
                    const targetY = targetCup.y;

                    const bottleCenterX = bottle.x + bottle.w / 2;
                    const bottleCenterY = bottle.y + bottle.h / 2;

                    // T√≠nh v·ªã tr√≠ mi·ªáng b√¨nh d·ª±a tr√™n g√≥c quay
                    const cos = Math.cos(bottle.angle);
                    const sin = Math.sin(bottle.angle);
                    // Mi·ªáng b√¨nh ·ªü ƒë·∫ßu tr√™n (ƒë·ªânh b√¨nh)
                    const mouthRelativeX = sin * bottle.h / 2;
                    const mouthRelativeY = -cos * bottle.h / 2;

                    const actualMouthX = bottleCenterX + mouthRelativeX;

                    // Ki·ªÉm tra: c·ªëc ph·∫£i n·∫±m v·ªÅ ph√≠a b√¨nh ƒëang nghi√™ng
                    const cupDirection = targetX - bottleCenterX; // D∆∞∆°ng = c·ªëc ·ªü b√™n ph·∫£i, √Çm = c·ªëc ·ªü b√™n tr√°i
                    const tiltDirection = mouthRelativeX; // D∆∞∆°ng = nghi√™ng ph·∫£i, √Çm = nghi√™ng tr√°i
                    const isSameDirection = (cupDirection * tiltDirection) > 0; // C√πng d·∫•u = c√πng h∆∞·ªõng

                    // Ki·ªÉm tra c√°c ƒëi·ªÅu ki·ªán
                    const angleInDegrees = bottle.angle * 180 / Math.PI;
                    const isBottleTilted = Math.abs(bottle.angle) > 0.17;
                    const isMouthAboveCup = mouthY < targetY + 50;

                    if (isBottleTilted && isMouthAboveCup && isSameDirection) {
                        const length = targetY - mouthY;

                        const gradient = ctx.createLinearGradient(mouthX, mouthY, targetX, targetY);
                        gradient.addColorStop(0, "rgba(0,150,255,0.8)");
                        gradient.addColorStop(0.5, "rgba(0,180,255,0.6)");
                        gradient.addColorStop(1, "rgba(0,200,255,0.2)");

                        ctx.beginPath();
                        for (let y = 0; y <= length; y += 5) {
                            const progress = y / length;
                            const xLerp = mouthX + (targetX - mouthX) * progress;
                            const yLerp = mouthY + (targetY - mouthY) * progress;
                            const offset = Math.sin((y / 25) * Math.PI * 2 + t) * 4;
                            const x = xLerp + offset - 10;
                            if (y === 0) ctx.moveTo(x, yLerp);
                            else ctx.lineTo(x, yLerp);
                        }
                        for (let y = length; y >= 0; y -= 5) {
                            const progress = y / length;
                            const xLerp = mouthX + (targetX - mouthX) * progress;
                            const yLerp = mouthY + (targetY - mouthY) * progress;
                            const offset = Math.sin((y / 25) * Math.PI * 2 + t) * 4;
                            ctx.lineTo(xLerp + offset + 10, yLerp);
                        }
                        ctx.closePath();
                        ctx.fillStyle = gradient;
                        ctx.fill();
                    }
                }
            }

            // Hi·ªÉn th·ªã th√¥ng tin b√¨nh
            if (bottle.showUnit) {
                ctx.fillStyle = "#1a202c";
                ctx.font = "bold 16px sans-serif";
                const bottleUnit = bottle.unit || 'l';
                const displayFill = bottleUnit === "l" ? (bottle.fill / 1000).toFixed(2) : Math.round(bottle
                    .fill);
                const displayCapacity = bottleUnit === "l" ? (bottle.capacity / 1000).toFixed(2) : bottle
                    .capacity;
                ctx.fillText(`B√¨nh: ${displayFill} / ${displayCapacity} ${bottleUnit}`, bottle.x - 20, bottle.y + bottle
                    .h + 50);
            }
        }

        function isNearCup(bottle, cup) {
            const margin = 50;

            // Ki·ªÉm tra kho·∫£ng c√°ch g·∫ßn
            const isInRange = (bottle.x < cup.x + cup.w + margin &&
                bottle.x + bottle.w > cup.x - margin &&
                bottle.y < cup.y + cup.h + margin &&
                bottle.y + bottle.h > cup.y - margin);

            if (!isInRange) return false;

            // Kh√¥ng ch·ªçn c·ªëc v·ª´a m·ªõi t·∫°o
            if (cup.justCreated) return false;

            // Ki·ªÉm tra b√¨nh ph·∫£i ·ªü b√™n ph·∫£i c·ªëc
            const bottleCenterX = bottle.x + bottle.w / 2;
            const cupCenterX = cup.x + cup.w / 2;
            const isBottleOnRight = bottleCenterX > cupCenterX;

            // Ki·ªÉm tra g√≥c tr√°i tr√™n b√¨nh ph·∫£i cao h∆°n c·∫°nh tr√™n c√πng c·ªßa c·ªëc m·ªôt kho·∫£ng theo t·ªâ l·ªá m√†n h√¨nh
            const bottleTopLeftY = bottle.y; // G√≥c tr√°i tr√™n c·ªßa b√¨nh
            const cupTopY = cup.y; // C·∫°nh tr√™n c√πng c·ªßa c·ªëc
            const minGap = canvas.height * 0.05; // Kho·∫£ng c√°ch t·ªëi thi·ªÉu = 5% chi·ªÅu cao canvas
            const isBottleHighEnough = bottleTopLeftY < (cupTopY - minGap); // B√¨nh ph·∫£i cao h∆°n c·ªëc √≠t nh·∫•t minGap

            // Ch·ªâ ch·ªçn c·ªëc khi ƒë·ªß c·∫£ 3 ƒëi·ªÅu ki·ªán
            return isBottleOnRight && isBottleHighEnough;
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            let nearestCup = null;
            let minDistance = Infinity;
            cups.forEach(cup => {
                const bottleCenterX = bottle.x + bottle.w / 2;
                const cupCenterX = cup.x + cup.w / 2;
                const isBottleOnRight = bottleCenterX > cupCenterX;

                if (isNearCup(bottle, cup) && cup.fill < cup.capacity && isBottleOnRight) {
                    const distance = Math.hypot((bottle.x + bottle.w / 2) - (cup.x + cup.w / 2), (bottle.y +
                        bottle.h / 2) - (cup.y + cup.h / 2));
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestCup = cup;
                    }
                }
            });

            if (!bottle.dragging && nearestCup && bottle.fill > 0) {
                bottle.pouring = true;
            } else if (bottle.dragging || !nearestCup || bottle.fill <= 0) {
                bottle.pouring = false;
            }

            if (bottle.pouring && nearestCup) {
                // T√≠nh t·ªça ƒë·ªô t√¢m b√¨nh v√† t√¢m c·ªëc
                const cx = bottle.x + bottle.w / 2;
                const cy = bottle.y + bottle.h / 2;
                const cupTargetX = nearestCup.x + nearestCup.w / 2;
                const cupTargetY = nearestCup.y;

                // T√≠nh g√≥c nghi√™ng t·ªëi ∆∞u t·ª´ t√¢m b√¨nh ƒë·∫øn ƒë·ªânh c·ªëc
                const dx = cupTargetX - cx;
                const dy = cupTargetY - cy;
                let targetAngle = Math.atan2(dy, dx) - Math.PI / 2;

                // Gi·ªõi h·∫°n g√≥c nghi√™ng t·ª´ ~-29¬∞ ƒë·∫øn ~-14¬∞
                const minAngle = -Math.PI * 0.16;
                const maxAngle = -Math.PI * 0.08;
                targetAngle = Math.max(minAngle, Math.min(maxAngle, targetAngle));

                // Xoay b√¨nh m∆∞·ª£t m√† v·ªÅ g√≥c m·ª•c ti√™u (smooth transition)
                bottle.angle += (targetAngle - bottle.angle) * 0.1;

                //  Ki·ªÉm tra b√¨nh ƒë√£ nghi√™ng ƒë·ªß g√≥c ch∆∞a (ƒë·ªÉ r√≥t n∆∞·ªõc)
                const isBottleTilted = Math.abs(bottle.angle) > 0.17; // Ph·∫£i nghi√™ng > ~10¬∞

                // Ch·ªâ r√≥t n∆∞·ªõc khi b√¨nh ƒë√£ nghi√™ng ƒë·ªß g√≥c
                if (isBottleTilted) {
                    // T√≠nh t·ªëc ƒë·ªô r√≥t d·ª±a tr√™n ƒë∆°n v·ªã ƒëo
                    const bottleUnit = bottle.unit || 'l';
                    const cupUnit = nearestCup.unit || 'l';

                    // T·ªëc ƒë·ªô c∆° b·∫£n: 2 ƒë∆°n v·ªã/frame
                    const basePourSpeed = 2;

                    // H·ªá s·ªë nh√¢n t·ªëc ƒë·ªô (ml r√≥t nhanh h∆°n l√≠t)
                    const bottleSpeedMultiplier = bottleUnit === 'ml' ? 1000 : 1;
                    const cupSpeedMultiplier = cupUnit === 'ml' ? 1000 : 1;

                    // L·∫•y t·ªëc ƒë·ªô trung b√¨nh gi·ªØa b√¨nh v√† c·ªëc
                    const speedMultiplier = (bottleSpeedMultiplier + cupSpeedMultiplier) / 2;
                    const calculatedSpeed = basePourSpeed * speedMultiplier;

                    // Gi·ªõi h·∫°n t·ªëc ƒë·ªô t·ªëi ƒëa: 15 ƒë∆°n v·ªã/frame
                    const maxSpeed = 15;
                    const pourSpeed = Math.min(calculatedSpeed, maxSpeed);

                    // T√≠nh l∆∞·ª£ng n∆∞·ªõc th·ª±c t·∫ø ƒë∆∞·ª£c r√≥t (kh√¥ng v∆∞·ª£t qu√° l∆∞·ª£ng c√≤n l·∫°i ho·∫∑c dung t√≠ch c·ªëc)
                    const actualPour = Math.min(pourSpeed, bottle.fill, nearestCup.capacity - nearestCup.fill);

                    // Chuy·ªÉn n∆∞·ªõc t·ª´ b√¨nh sang c·ªëc
                    nearestCup.fill += actualPour;
                    bottle.fill -= actualPour;

                    // D·ª´ng r√≥t khi c·ªëc ƒë·∫ßy
                    if (nearestCup.fill >= nearestCup.capacity) {
                        nearestCup.fill = nearestCup.capacity;
                        bottle.pouring = false;
                    }
                }
            }
            if (!bottle.pouring) {
                bottle.angle += (0 - bottle.angle) * 0.1;
            }

            t += 0.05;
            cups.forEach((c, i) => drawCup(c, i, c === nearestCup));
            drawBottle();
            requestAnimationFrame(animate);
        }

        function addCup(type = 'normal') {
            if (cups.length >= 5) {
                alert("‚ö†Ô∏è Ch·ªâ c√≥ th·ªÉ t·∫°o t·ªëi ƒëa 5 c·ªëc!");
                return;
            }

            const baseCup = cups[0];
            const lastCup = cups[cups.length - 1];
            let newX = lastCup.x + lastCup.w + 35;
            let newY = lastCup.y;

            let newW, newH, newCapacity;

            if (type === 'measuring') {
                if (measuredCupEmpty.complete) {
                    const ratio = measuredCupEmpty.naturalWidth / measuredCupEmpty.naturalHeight;
                    newH = 160;
                    newW = newH * ratio;
                } else {
                    newW = 100;
                    newH = 160;
                }
                newCapacity = 1000;
            } else {
                if (cupEmpty.complete) {
                    const ratio = cupEmpty.naturalWidth / cupEmpty.naturalHeight;
                    newH = 130;
                    newW = newH * ratio;
                } else {
                    newW = 120;
                    newH = 130;
                }
                newCapacity = 1000;
            }

            if (newX + newW > canvas.width - 50) {
                newX = 200;
                newY = lastCup.y - newH - 30;
            }

            // Ki·ªÉm tra tr·∫°ng th√°i hi·ªÉn th·ªã: l·∫•y t·ª´ c·ªëc cu·ªëi c√πng ho·∫∑c t·ª´ b√¨nh
            const inheritShowUnit = cups.length > 0 ? lastCup.showUnit : bottle.showUnit;
            const inheritUnit = cups.length > 0 ? lastCup.unit : bottle.unit;

            const newCup = {
                x: newX,
                y: newY,
                w: newW,
                h: newH,
                capacity: newCapacity,
                fill: 0,
                dragging: false,
                offsetX: 0,
                offsetY: 0,
                showUnit: inheritShowUnit,
                showScale: type === 'measuring',
                type: type,
                unit: inheritUnit,
                justCreated: true
            };

            cups.push(newCup);
            updateSettingsPanel();
            updateAddCupButton();
        }

        function removeCup(index) {
            if (cups.length > 1) {
                cups.splice(index, 1);
                updateSettingsPanel();
                updateAddCupButton();
            } else {
                alert("‚ö†Ô∏è Ph·∫£i c√≥ √≠t nh·∫•t 1 c·ªëc!");
            }
        }

        function updateAddCupButton() {
            const btn = document.getElementById("btnAddCup");
            const btnMeasuring = document.getElementById("btnAddMeasuringCup");
            const totalCups = cups.length;
            btn.textContent = `Th√™m c·ªëc th∆∞·ªùng (${totalCups}/5)`;
            btnMeasuring.textContent = `üìè Th√™m c·ªëc ƒëo 1L (${totalCups}/5)`;

            if (totalCups >= 5) {
                btn.disabled = true;
                btnMeasuring.disabled = true;
            } else {
                btn.disabled = false;
                btnMeasuring.disabled = false;
            }
        }

        function updateSettingsPanel() {
            const normalContainer = document.getElementById("cupsSettingsContainer");
            const measuringContainer = document.getElementById("measuringCupsSettingsContainer");
            normalContainer.innerHTML = "";
            measuringContainer.innerHTML = "";

            const normalCups = cups.filter(c => c.type === 'normal');
            const measuringCups = cups.filter(c => c.type === 'measuring');

            // C·ªëc th∆∞·ªùng
            if (normalCups.length === 0) {
                normalContainer.innerHTML =
                    '<p style="color: #718096; font-size: 13px; padding: 8px;">Ch∆∞a c√≥ c·ªëc th∆∞·ªùng n√†o</p>';
            } else {
                //N√∫t ƒë·ªïi ƒë∆°n v·ªã h√†ng lo·∫°t
                const bulkUnitBtn = document.createElement("button");
                bulkUnitBtn.className = "hide-all-btn";
                bulkUnitBtn.style.marginBottom = "8px";
                const currentUnit = normalCups[0].unit || 'l';
                bulkUnitBtn.textContent = currentUnit === 'l' ? "üîÑ ƒê·ªïi sang ml (c·ªëc th∆∞·ªùng)" :
                    "üîÑ ƒê·ªïi sang l√≠t (c·ªëc th∆∞·ªùng)";
                if (currentUnit === 'ml') {
                    bulkUnitBtn.classList.add('ml-state');
                }
                bulkUnitBtn.onclick = () => {
                    const currentUnit = normalCups[0].unit || 'l';
                    const newUnit = currentUnit === 'l' ? 'ml' : 'l';
                    normalCups.forEach(c => c.unit = newUnit);
                    applySettings();
                    updateSettingsPanel();
                };
                normalContainer.appendChild(bulkUnitBtn);


                normalCups.forEach((cup, localIndex) => {
                    const globalIndex = cups.indexOf(cup);
                    normalContainer.appendChild(createCupSettingItem(cup, globalIndex, localIndex + 1));
                });
            }

            // C·ªëc ƒëo
            if (measuringCups.length === 0) {
                measuringContainer.innerHTML =
                    '<p style="color: #718096; font-size: 13px; padding: 8px;">Ch∆∞a c√≥ c·ªëc ƒëo n√†o</p>';
            } else {

                const bulkUnitBtn = document.createElement("button");
                bulkUnitBtn.className = "hide-all-btn";
                bulkUnitBtn.style.marginBottom = "8px";
                const currentUnit = measuringCups[0].unit || 'l';
                bulkUnitBtn.textContent = currentUnit === 'l' ? "üîÑ ƒê·ªïi sang ml (c·ªëc ƒëo)" : "üîÑ ƒê·ªïi sang l√≠t (c·ªëc ƒëo)";
                if (currentUnit === 'ml') {
                    bulkUnitBtn.classList.add('ml-state');
                }
                bulkUnitBtn.onclick = () => {
                    const currentUnit = measuringCups[0].unit || 'l';
                    const newUnit = currentUnit === 'l' ? 'ml' : 'l';
                    measuringCups.forEach(c => c.unit = newUnit);
                    applySettings();
                    updateToggleButtonText();
                };
                measuringContainer.appendChild(bulkUnitBtn);


                measuringCups.forEach((cup, localIndex) => {
                    const globalIndex = cups.indexOf(cup);
                    measuringContainer.appendChild(createCupSettingItem(cup, globalIndex, localIndex + 1));
                });
            }

            // C·∫≠p nh·∫≠t text c·ªßa n√∫t toggle
            updateToggleButtonText();
        }

        function updateToggleButtonText() {
            const btn = document.getElementById("toggleAllUnits");
            const allHidden = bottle.showUnit === false && cups.every(c => c.showUnit === false);
            if (allHidden) {
                btn.textContent = "üëÅÔ∏è‚Äçüó®Ô∏è Hi·ªán t·∫•t c·∫£ ƒë∆°n v·ªã ƒëo";
                btn.classList.add("hidden-state"); // ‚Üê TH√äM class m√†u cam
            } else {
                btn.textContent = "üëÅÔ∏è ·∫®n t·∫•t c·∫£ ƒë∆°n v·ªã ƒëo";
                btn.classList.remove("hidden-state"); // ‚Üê B·ªè class m√†u cam
            }
        }

        function createCupSettingItem(cup, globalIndex, displayIndex) {
            const div = document.createElement("div");
            div.className = "cup-item";

            const header = document.createElement("div");
            header.className = "cup-header";
            header.style.cursor = "pointer";

            const cupName = document.createElement("span");
            const cupTypeText = cup.type === 'measuring' ? 'C·ªëc ƒëo' : 'C·ªëc';
            cupName.textContent = `${cupTypeText} ${displayIndex}`;

            const cupInfo = document.createElement("span");
            cupInfo.style.fontSize = "13px";
            cupInfo.style.color = "#718096";
            const cupUnit = cup.unit || 'l';
            const displayFill = cupUnit === "l" ? (cup.fill / 1000).toFixed(1) : Math.round(cup.fill);
            const displayCapacity = cupUnit === "l" ? (cup.capacity / 1000).toFixed(1) : cup.capacity;
            cupInfo.textContent = `${displayFill}${cupUnit} / ${displayCapacity}${cupUnit}`;
            header.appendChild(cupName);
            header.appendChild(cupInfo);

            const details = document.createElement("div");
            details.className = "cup-details";

            // Ch·ªçn ƒë∆°n v·ªã
            const unitLabel = document.createElement("label");
            unitLabel.textContent = "ƒê∆°n v·ªã ƒëo:";
            const unitSelect = document.createElement("select");
            unitSelect.id = `cup${globalIndex}UnitSelect`;
            unitSelect.innerHTML = `
    <option value="ml">Mililit (ml)</option>
    <option value="l">L√≠t (l)</option>
`;
            unitSelect.value = cup.unit || 'l';
            unitSelect.addEventListener('change', (e) => {
                cup.unit = e.target.value;
                settingsChanged = true;
                updateSettingsPanel();
            });
            details.appendChild(unitLabel);
            details.appendChild(unitSelect);

            const fillLabel = document.createElement("label");
            fillLabel.textContent = "M·ª©c n∆∞·ªõc hi·ªán t·∫°i:";

            const fillInput = document.createElement("input");
            fillInput.type = "number";
            fillInput.id = `cup${globalIndex}FillInput`;
            fillInput.value = cupUnit === "l" ? (cup.fill / 1000).toFixed(2) : Math.round(cup
                .fill);
            fillInput.min = "0";
            fillInput.max = cupUnit === "l" ? (cup.capacity / 1000).toFixed(2) : cup.capacity;
            fillInput.step = cupUnit === "l" ? "0.01" : "1";
            fillInput.addEventListener('input', () => settingsChanged = true);

            details.appendChild(fillLabel);
            details.appendChild(fillInput);

            // Dung t√≠ch - ch·ªâ cho ph√©p ch·ªânh s·ª≠a n·∫øu kh√¥ng ph·∫£i c·ªëc ƒëo 1L
            if (cup.type !== 'measuring') {
                const capacityLabel = document.createElement("label");
                capacityLabel.textContent = "Dung t√≠ch t·ªëi ƒëa:";
                capacityLabel.style.marginTop = "8px";

                const capacityInput = document.createElement("input");
                capacityInput.type = "number";
                capacityInput.id = `cup${globalIndex}CapacityInput`;
                capacityInput.value = cupUnit === "l" ? (cup.capacity / 1000).toFixed(2) : cup.capacity;
                capacityInput.min = "1";
                capacityInput.step = cupUnit === "l" ? "0.01" : "1";
                capacityInput.addEventListener('input', () => settingsChanged = true);

                details.appendChild(capacityLabel);
                details.appendChild(capacityInput);
            } else {
                const capacityNote = document.createElement("p");
                capacityNote.style.fontSize = "12px";
                capacityNote.style.color = "#718096";
                capacityNote.style.marginTop = "8px";
                capacityNote.style.fontStyle = "italic";
                capacityNote.textContent = "Dung t√≠ch c·ªë ƒë·ªãnh: 1000ml (1L)";
                details.appendChild(capacityNote);
            }

            // Checkbox hi·ªÉn th·ªã ƒë∆°n v·ªã
            const showUnitLabel = document.createElement("label");
            showUnitLabel.className = "checkbox-label";
            const showUnitCheckbox = document.createElement("input");
            showUnitCheckbox.type = "checkbox";
            showUnitCheckbox.id = `cup${globalIndex}ShowUnit`;
            showUnitCheckbox.checked = cup.showUnit;
            showUnitCheckbox.addEventListener('change', () => {
                settingsChanged = true;
                cup.showUnit = showUnitCheckbox.checked;
            });
            const showUnitText = document.createElement("span");
            showUnitText.textContent = "Hi·ªÉn th·ªã ƒë∆°n v·ªã ƒëo";
            showUnitLabel.appendChild(showUnitCheckbox);
            showUnitLabel.appendChild(showUnitText);
            details.appendChild(showUnitLabel);

            // Checkbox hi·ªÉn th·ªã v·∫°ch chia (ch·ªâ cho c·ªëc ƒëo)
            if (cup.type === 'measuring') {
                const showScaleLabel = document.createElement("label");
                showScaleLabel.className = "checkbox-label";
                const showScaleCheckbox = document.createElement("input");
                showScaleCheckbox.type = "checkbox";
                showScaleCheckbox.id = `cup${globalIndex}ShowScale`;
                showScaleCheckbox.checked = cup.showScale;
                showScaleCheckbox.addEventListener('change', () => {
                    settingsChanged = true;
                    cup.showScale = showScaleCheckbox.checked;
                });
                const showScaleText = document.createElement("span");
                showScaleText.textContent = "Hi·ªÉn th·ªã v·∫°ch chia";
                showScaleLabel.appendChild(showScaleCheckbox);
                showScaleLabel.appendChild(showScaleText);
                details.appendChild(showScaleLabel);
            }

            if (cups.length > 1) {
                const deleteBtn = document.createElement("button");
                deleteBtn.className = "delete-btn";
                deleteBtn.textContent = "üóë X√≥a c·ªëc";
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeCup(globalIndex);
                    settingsChanged = true;
                };
                details.appendChild(deleteBtn);
            }

            div.appendChild(header);
            div.appendChild(details);

            header.addEventListener("click", () => {
                const wasExpanded = div.classList.contains("expanded");

                document.querySelectorAll(".cup-item").forEach(item => {
                    item.classList.remove("expanded");
                });

                if (!wasExpanded) {
                    div.classList.add("expanded");
                }
            });

            return div;
        }

        // Event Listeners
        document.getElementById("btnAddCup").addEventListener("click", () => addCup('normal'));
        document.getElementById("btnAddMeasuringCup").addEventListener("click", () => addCup('measuring'));

        document.getElementById("resetBtn").addEventListener("click", () => {
            bottle = JSON.parse(JSON.stringify(initialState.bottle));
            cups = JSON.parse(JSON.stringify(initialState.cups));
            if (bottleEmpty.complete) setSizeKeepRatio(bottle, bottleEmpty, 210);
            if (cupEmpty.complete) {
                cups.forEach(c => {
                    if (c.type === 'normal') {
                        setSizeKeepRatio(c, cupEmpty, 130);
                    }
                });
            }
            if (measuredCupEmpty.complete) {
                cups.forEach(c => {
                    if (c.type === 'measuring') {
                        setSizeKeepRatio(c, measuredCupEmpty, 160);
                    }
                });
            }
            updateSettingsPanel();
            updateAddCupButton();
            settingsChanged = false;
        });

        document.getElementById("settingsBtn").addEventListener("click", () => {
            const panel = document.getElementById("settingsPanel");
            const overlay = document.getElementById("settingsOverlay");
            const isOpen = panel.classList.contains("active");

            if (isOpen) {
                // ƒêang m·ªü, mu·ªën ƒë√≥ng
                if (settingsChanged) {
                    // C√≥ thay ƒë·ªïi ch∆∞a l∆∞u
                    document.getElementById("confirmModal").classList.add("active");
                } else {
                    // Kh√¥ng c√≥ thay ƒë·ªïi, ƒë√≥ng v·ªõi animation
                    panel.classList.remove("active");
                    overlay.classList.remove("active");
                }
            } else {
                // ƒêang ƒë√≥ng, mu·ªën m·ªü
                savedState = {
                    bottle: JSON.parse(JSON.stringify(bottle)),
                    cups: JSON.parse(JSON.stringify(cups)),
                };
                settingsChanged = false;

                // Hi·ªán overlay tr∆∞·ªõc, sau ƒë√≥ hi·ªán panel
                overlay.classList.add("active");
                // Delay nh·ªè ƒë·ªÉ animation m∆∞·ª£t h∆°n
                setTimeout(() => {
                    panel.classList.add("active");
                }, 10);

                document.getElementById("bottleUnitSelect").value = bottle.unit || 'l';
                const bottleUnit = bottle.unit || 'l';
                document.getElementById("bottleFillInput").value = bottleUnit === "l" ? (bottle.fill / 1000)
                    .toFixed(2) : Math.round(bottle.fill);
                document.getElementById("bottleFillInput").step = bottleUnit === "l" ? "0.01" : "1";
                document.getElementById("bottleCapacityInput").value = bottleUnit === "l" ? (bottle.capacity /
                    1000).toFixed(2) : bottle.capacity;
                document.getElementById("bottleCapacityInput").step = bottleUnit === "l" ? "0.01" : "1";
                document.getElementById("bottleShowUnit").checked = bottle.showUnit;
                updateSettingsPanel();
            }
        });
        // Modal confirm buttons
        document.getElementById("modalConfirm").addEventListener("click", () => {
            // L∆∞u thay ƒë·ªïi
            applySettings();

            document.getElementById("confirmModal").classList.remove("active");
            document.getElementById("settingsPanel").classList.remove("active");
            document.getElementById("settingsOverlay").classList.remove("active");
            settingsChanged = false;
        });

        document.getElementById("modalCancel").addEventListener("click", () => {
            // Quay l·∫°i panel ƒë·ªÉ l∆∞u
            document.getElementById("confirmModal").classList.remove("active");
        });

        document.getElementById("toggleAllUnits").addEventListener("click", () => {
            const btn = document.getElementById("toggleAllUnits");
            const allHidden = bottle.showUnit === false && cups.every(c => c.showUnit === false);

            if (allHidden) {
                // Hi·ªán t·∫•t c·∫£
                bottle.showUnit = true;
                cups.forEach(c => c.showUnit = true);
                document.getElementById("bottleShowUnit").checked = true;
                cups.forEach((c, i) => {
                    const checkbox = document.getElementById(`cup${i}ShowUnit`);
                    if (checkbox) checkbox.checked = true;
                });
                btn.textContent = "üëÅÔ∏è ·∫®n t·∫•t c·∫£ ƒë∆°n v·ªã ƒëo";
                btn.classList.remove("hidden-state");
            } else {
                // ·∫®n t·∫•t c·∫£
                bottle.showUnit = false;
                cups.forEach(c => c.showUnit = false);
                document.getElementById("bottleShowUnit").checked = false;
                cups.forEach((c, i) => {
                    const checkbox = document.getElementById(`cup${i}ShowUnit`);
                    if (checkbox) checkbox.checked = false;
                });
                btn.textContent = "üëÅÔ∏è‚Äçüó®Ô∏è Hi·ªán t·∫•t c·∫£ ƒë∆°n v·ªã ƒëo";
                btn.classList.remove("hidden-state");
            }
            applySettings();
            updateToggleButtonText(); // C·∫≠p nh·∫≠t text sau khi thay ƒë·ªïi
        });

        function applySettings() {
            const bottleUnit = bottle.unit || 'l';
            const bottleFillValue = parseFloat(document.getElementById("bottleFillInput").value);
            const bottleCapacityValue = parseFloat(document.getElementById("bottleCapacityInput").value);
            bottle.showUnit = document.getElementById("bottleShowUnit").checked;

            if (!isNaN(bottleCapacityValue) && bottleCapacityValue > 0) {
                bottle.capacity = bottleUnit === "l" ? bottleCapacityValue * 1000 : bottleCapacityValue;
            }
            if (!isNaN(bottleFillValue)) {
                bottle.fill = Math.max(0, Math.min(bottle.capacity, bottleUnit === "l" ? bottleFillValue * 1000 :
                    bottleFillValue));
            }

            cups.forEach((c, i) => {
                const cupUnit = c.unit || 'l';
                const fillInput = document.getElementById(`cup${i}FillInput`);
                const capacityInput = document.getElementById(`cup${i}CapacityInput`);
                const showUnitCheckbox = document.getElementById(`cup${i}ShowUnit`);
                const showScaleCheckbox = document.getElementById(`cup${i}ShowScale`);

                // C·ªëc ƒëo 1L kh√¥ng cho ph√©p thay ƒë·ªïi dung t√≠ch
                if (capacityInput && c.type !== 'measuring') {
                    const capacityVal = parseFloat(capacityInput.value);
                    if (!isNaN(capacityVal) && capacityVal > 0) {
                        c.capacity = cupUnit === "l" ? capacityVal * 1000 : capacityVal;
                    }
                }

                if (fillInput) {
                    const fillVal = parseFloat(fillInput.value);
                    if (!isNaN(fillVal)) {
                        c.fill = Math.max(0, Math.min(c.capacity, cupUnit === "l" ? fillVal * 1000 :
                            fillVal));
                    }
                }
                if (showUnitCheckbox) {
                    c.showUnit = showUnitCheckbox.checked;
                }
                if (showScaleCheckbox) {
                    c.showScale = showScaleCheckbox.checked;
                }
            });

            settingsChanged = false;
            updateSettingsPanel();
        }

        document.getElementById("applySettings").addEventListener("click", () => {
            applySettings();
            // ƒê√≥ng v·ªõi animation
            document.getElementById("settingsPanel").classList.remove("active");
            document.getElementById("settingsOverlay").classList.remove("active");
        });

        // C√°c input trong ph·∫ßn b√¨nh n∆∞·ªõc
        document.getElementById("bottleFillInput").addEventListener('input', () => settingsChanged = true);
        document.getElementById("bottleCapacityInput").addEventListener('input', () => settingsChanged = true);
        document.getElementById("bottleShowUnit").addEventListener('change', () => {
            settingsChanged = true;
            bottle.showUnit = document.getElementById("bottleShowUnit").checked;
        });

        document.getElementById("settingsPanel").addEventListener("keydown", (e) => {
            if (e.key === "Enter" && e.target.tagName === "INPUT") {
                e.preventDefault();
                applySettings();
            }
        });

        document.getElementById("settingsPanel").addEventListener("change", (e) => {
            if (e.target.id === "bottleUnitSelect") {
                bottle.unit = e.target.value;
                const bottleUnit = bottle.unit;

                // C·∫≠p nh·∫≠t input b√¨nh
                document.getElementById("bottleFillInput").value = bottleUnit === "l" ? (bottle.fill / 1000)
                    .toFixed(2) : Math.round(bottle.fill);
                document.getElementById("bottleFillInput").step = bottleUnit === "l" ? "0.01" : "1";
                document.getElementById("bottleFillInput").max = bottleUnit === "l" ? (bottle.capacity / 1000)
                    .toFixed(2) : bottle.capacity;
                document.getElementById("bottleCapacityInput").value = bottleUnit === "l" ? (bottle.capacity /
                    1000).toFixed(2) : bottle.capacity;
                document.getElementById("bottleCapacityInput").step = bottleUnit === "l" ? "0.01" : "1";

                settingsChanged = true;
            }
        });

        // Click v√†o overlay ƒë·ªÉ ƒë√≥ng settings
        document.getElementById("settingsOverlay").addEventListener("click", () => {
            const panel = document.getElementById("settingsPanel");
            const overlay = document.getElementById("settingsOverlay");

            if (settingsChanged) {
                // C√≥ thay ƒë·ªïi ch∆∞a l∆∞u - hi·ªán modal x√°c nh·∫≠n
                document.getElementById("confirmModal").classList.add("active");
            } else {
                // Kh√¥ng c√≥ thay ƒë·ªïi - ƒë√≥ng v·ªõi animation
                panel.classList.remove("active");
                overlay.classList.remove("active");
            }
        });
        canvas.addEventListener("mousedown", e => {
            const mx = e.offsetX,
                my = e.offsetY;
            if (mx > bottle.x && mx < bottle.x + bottle.w && my > bottle.y && my < bottle.y + bottle.h) {
                bottle.dragging = true;
                bottle.offsetX = mx - bottle.x;
                bottle.offsetY = my - bottle.y;

                // Reset t·∫•t c·∫£ flag justCreated khi ch·∫°m v√†o b√¨nh
                cups.forEach(c => c.justCreated = false);

                return;
            }
            for (let i = cups.length - 1; i >= 0; i--) {
                const c = cups[i];
                if (mx > c.x && mx < c.x + c.w && my > c.y && my < c.y + c.h) {
                    c.dragging = true;
                    c.offsetX = mx - c.x;
                    c.offsetY = my - c.y;
                    break;
                }
            }
        });

        canvas.addEventListener("mousemove", e => {
            const mx = e.offsetX,
                my = e.offsetY;
            if (bottle.dragging) {
                bottle.x = mx - bottle.offsetX;
                bottle.y = my - bottle.offsetY;

                // Reset t·∫•t c·∫£ flag justCreated khi di chuy·ªÉn b√¨nh
                cups.forEach(c => c.justCreated = false);
            }
            cups.forEach(c => {
                if (c.dragging) {
                    c.x = mx - c.offsetX;
                    c.y = my - c.offsetY;
                }
            });
        });

        canvas.addEventListener("mouseup", () => {
            bottle.dragging = false;
            cups.forEach(c => c.dragging = false);
        });

        // Ki·ªÉm tra xem user ƒë√£ xem h∆∞·ªõng d·∫´n ch∆∞a
        const hasSeenTutorial = localStorage.getItem('hasSeenTutorial');
        const toastBanner = document.getElementById('toastBanner');
        const helpModal = document.getElementById('helpModal');

        // Hi·ªÉn th·ªã toast n·∫øu l·∫ßn ƒë·∫ßu
        if (!hasSeenTutorial) {
            setTimeout(() => {
                toastBanner.classList.add('show');
            }, 500); // Delay 0.5s sau khi load
        }

        // N√∫t "Xem h∆∞·ªõng d·∫´n" tr√™n toast
        document.getElementById('toastHelpBtn').addEventListener('click', () => {
            helpModal.classList.add('active');
            toastBanner.classList.remove('show');
        });

        // N√∫t "ƒê√£ hi·ªÉu" tr√™n toast
        document.getElementById('toastDismissBtn').addEventListener('click', () => {
            toastBanner.classList.remove('show');
            localStorage.setItem('hasSeenTutorial', 'true');
        });

        // N√∫t "√ó" ƒë√≥ng toast
        document.getElementById('toastCloseBtn').addEventListener('click', () => {
            toastBanner.classList.remove('show');
        });

        // N√∫t "üìñ H∆∞·ªõng d·∫´n" trong header
        document.getElementById('helpBtn').addEventListener('click', () => {
            helpModal.classList.add('active');
        });

        // N√∫t "√ó" ƒë√≥ng help modal
        document.getElementById('closeHelpBtn').addEventListener('click', () => {
            helpModal.classList.remove('active');
        });

        // Click v√†o overlay ƒë·ªÉ ƒë√≥ng help modal
        helpModal.addEventListener('click', (e) => {
            if (e.target === helpModal) {
                helpModal.classList.remove('active');
            }
        });

        // ƒê√°nh d·∫•u ƒë√£ xem tutorial khi m·ªü help panel
        helpModal.addEventListener('click', () => {
            if (!localStorage.getItem('hasSeenTutorial')) {
                localStorage.setItem('hasSeenTutorial', 'true');
            }
        });
    </script>
</body>

</html>